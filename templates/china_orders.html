<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>–ó–∞–∫–∞–∑—ã –∏–∑ –ö–∏—Ç–∞—è</title>
  <style>
    :root{
      --bg1:#0e0f1e; --bg2:#1a1d3a; --card:#141738; --stroke:#252b56;
      --txt:#eaf0ff; --muted:#a7b0e0; --grad1:#ff4d6d; --grad2:#ff9a3c;
      --radius:22px; --pad:clamp(12px,2.5vw,24px);
      --input-pad:12px; --gap:12px;
      --shadow:0 24px 60px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.05);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Ubuntu, sans-serif; color:var(--txt);
      background:
        radial-gradient(1200px 800px at 80% -10%, #ff4d6d22, transparent 60%),
        radial-gradient(900px 600px at -10% 110%, #ff9a3c22, transparent 60%),
        linear-gradient(180deg,var(--bg1),var(--bg2));
      padding:var(--pad);
      padding-left:calc(env(safe-area-inset-left) + var(--pad));
      padding-right:calc(env(safe-area-inset-right) + var(--pad));
      padding-top:calc(env(safe-area-inset-top) + var(--pad));
      padding-bottom:calc(env(safe-area-inset-bottom) + var(--pad));
      display:flex; justify-content:center;
    }
    .container{width:min(1100px, 100%);}

    .header{
      display:flex; flex-direction:column; align-items:center; text-align:center; gap:10px; margin-bottom:16px;
    }
    .logo{
      width:64px; height:64px; border-radius:18px; display:grid; place-items:center; font-size:28px;
      background:linear-gradient(135deg,var(--grad1),var(--grad2));
      box-shadow:0 10px 24px rgba(255,154,60,.28), inset 0 -6px 10px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.2);
      user-select:none;
    }
    .header h1{margin:0; font-size:24px; letter-spacing:.3px}
    .header .hint{margin:0; color:var(--muted); font-size:14px; max-width:70ch}

    .back-wrap{display:flex; justify-content:center; margin:10px 0 18px}
    .back-btn{
      display:inline-flex; align-items:center; gap:10px; padding:12px 16px; border:0; border-radius:14px; cursor:pointer;
      font-weight:800; letter-spacing:.3px; color:#0b0e27; text-decoration:none;
      background:linear-gradient(135deg, #bfc7ff, #89f0ff);
      box-shadow:0 8px 18px rgba(137,240,255,.30), inset 0 -4px 8px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.25);
      white-space:nowrap;
    }

    .card{
      background:linear-gradient(180deg, var(--card), #0d1030);
      border:1px solid var(--stroke); border-radius:var(--radius); padding:16px; box-shadow:var(--shadow);
      margin-bottom:16px;
    }

    .row{display:grid; gap:var(--gap); grid-template-columns: repeat(4, 1fr);}
    .field{display:flex; flex-direction:column; gap:6px}
    label{font-size:12px; color:#cdd4ff}
    input, select{
      padding:var(--input-pad); border-radius:14px; border:1px solid #2a3063; background:#0a0d26; color:var(--txt);
      box-shadow: inset 0 2px 6px rgba(0,0,0,.55), inset 0 1px 0 rgba(255,255,255,.05); outline:none;
      min-width:0;
    }
    input:focus, select:focus{border-color:#ff6d5a; outline:2px solid #ff6d5a55; outline-offset:2px}

    .table-wrap{width:100%; overflow-x:auto; -webkit-overflow-scrolling:touch; scrollbar-width:thin;}
    .table{width:100%; border-collapse:separate; border-spacing:0 10px; min-width:720px;}
    .table th{font-size:12px; color:#cdd4ff; text-align:left; padding:0 10px; white-space:nowrap;}
    .table td{background:#0a0d26; border:1px solid #2a3063; color:var(--txt); padding:10px; border-left-width:1px; vertical-align:middle;}
    .table tr td:first-child{border-radius:12px 0 0 12px}
    .table tr td:last-child{border-radius:0 12px 12px 0}
    .num{width:110px}

    .actions{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
    .btn{
      display:inline-block; padding:12px 16px; border:0; border-radius:14px; cursor:pointer; font-weight:800; letter-spacing:.3px; color:#0b0e27;
      background:linear-gradient(135deg,var(--grad1),var(--grad2));
      box-shadow:0 6px 14px rgba(255,154,60,.30), inset 0 -4px 8px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.25);
      touch-action:manipulation; white-space:nowrap;
    }
    .btn:active{transform:translateY(2px)}

    .totals{display:flex; justify-content:center; gap:24px; align-items:center}
    .totals .sum{font-size:18px; font-weight:800}

    /* Toasts */
    .toasts{
      position:fixed; left:50%; bottom:20px; transform:translateX(-50%);
      display:flex; flex-direction:column; gap:10px; z-index:9999; width:min(92vw, 520px);
      pointer-events:none;
    }
    .toast{
      pointer-events:auto;
      display:flex; align-items:center; gap:10px;
      padding:12px 16px; border-radius:14px; font-weight:700;
      background:linear-gradient(135deg,#24d39a,#2fb2ff); color:#071b1a;
      box-shadow:0 14px 40px rgba(0,0,0,.5), inset 0 1px 0 rgba(255,255,255,.35);
      animation: slideUp .3s ease, fadeOut .3s ease 4.2s forwards;
    }
    .toast.err{ background:linear-gradient(135deg,#ff6b6b,#ff9a3c); color:#2e0606 }
    .toast .x{ margin-left:auto; background:transparent; border:0; font-size:18px; cursor:pointer; opacity:.7 }
    @keyframes slideUp{ from{ transform:translate(-50%,10px); opacity:0 } to{ transform:translate(-50%,0); opacity:1 } }
    @keyframes fadeOut{ to{ opacity:0; transform:translate(-50%,8px) } }

    /* Responsive */
    @media (max-width: 900px){ .row{grid-template-columns: 1fr 1fr} .num{width:auto} }
    @media (max-width: 520px){
      :root{ --radius:18px; --input-pad:10px }
      .row{grid-template-columns: 1fr}
      .card{ padding:12px }
      .header h1{font-size:22px}
      .header .hint{font-size:13px}
      .table{ border-spacing:0 8px; min-width:640px }
      .table th{ font-size:11px; padding:0 8px }
      .table td{ padding:8px }
      .actions{flex-direction:column}
      .actions .btn{ width:100% }
      #items td .btn{ padding:10px 12px }
      .back-btn{ padding:10px 14px; font-size:14px }
    }
    @media (max-width: 360px){ .logo{ width:56px; height:56px; font-size:24px } label{ font-size:11px } input, select{ font-size:14px } .table{ min-width:580px } }
  </style>
</head>
<body>
  <div class="container">

    <div class="header">
      <div class="logo" aria-hidden="true">üá®üá≥</div>
      <h1>–ó–∞–∫–∞–∑—ã –∏–∑ –ö–∏—Ç–∞—è</h1>
      <p class="hint">–î–æ–±–∞–≤–ª—è–π—Ç–µ –ø–æ–∑–∏—Ü–∏–∏ –∑–∞–∫–∞–∑–∞: –º–æ–¥–µ–ª—å, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ, —Ü–µ–Ω–∞ ‚Äî —Å—É–º–º–∞ —Å—á–∏—Ç–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (–º–∞–∫–µ—Ç; –±–µ–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è).</p>
    </div>

    <div class="back-wrap">
      <a class="back-btn" href="/admin/products">‚Üê –ù–∞–∑–∞–¥ –≤ –∞–¥–º–∏–Ω–∫—É</a>
    </div>

    <div class="card">
      <div class="row">
        <div class="field">
          <label for="date">–î–∞—Ç–∞</label>
          <input id="date" type="date">
        </div>
        <div class="field">
          <label for="vendor">–ü–æ—Å—Ç–∞–≤—â–∏–∫</label>
          <input id="vendor" placeholder="Shenzhen ...">
        </div>
        <div class="field">
          <label for="currency">–í–∞–ª—é—Ç–∞</label>
          <select id="currency">
            <option value="TJS">TJS</option>
            <option value="CNY">CNY</option>
            <option value="USD">USD</option>
          </select>
        </div>
        <div class="field">
          <label for="note">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
          <input id="note" placeholder="–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ">
        </div>
      </div>
    </div>

    <div class="card">
      <div class="table-wrap">
        <table class="table" id="items">
          <thead>
            <tr>
              <th>–ë—Ä–µ–Ω–¥</th>
              <th>–ú–æ–¥–µ–ª—å</th>
              <th>–ö–∞—á–µ—Å—Ç–≤–æ</th>
              <th class="num">–¶–µ–Ω–∞</th>
              <th class="num">–ö–æ–ª-–≤–æ</th>
              <th class="num">–°—É–º–º–∞</th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="actions">
        <button class="btn" onclick="addRow()">Ôºã –î–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é</button>
        <button class="btn" id="saveBtn" onclick="saveOrder()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–∫–∞–∑</button>
      </div>
    </div>

    <div class="card">
      <div class="totals">
        <div>–í—Å–µ–≥–æ –ø–æ–∑–∏—Ü–∏–π: <b id="count">0</b></div>
        <div class="sum">–ò—Ç–æ–≥–æ: <span id="total">0</span> <span id="cur">TJS</span></div>
      </div>
    </div>

  </div>

  <!-- Toast stack -->
  <div class="toasts" id="toasts"></div>

  <script>
    const tbody = document.querySelector('#items tbody');
    const totalEl = document.getElementById('total');
    const countEl = document.getElementById('count');
    const curEl = document.getElementById('cur');
    const currencySel = document.getElementById('currency');
    const saveBtn = document.getElementById('saveBtn');
    const toasts = document.getElementById('toasts');

    function toast(msg, type='ok'){
      const el = document.createElement('div');
      el.className = 'toast' + (type==='err' ? ' err' : '');
      el.innerHTML = `<span>${msg}</span><button class="x" onclick="this.parentElement.remove()">√ó</button>`;
      toasts.appendChild(el);
      setTimeout(()=> el.remove(), 4500);
    }

    currencySel.addEventListener('change', ()=> curEl.textContent = currencySel.value);

    function addRow(data={}){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input placeholder="Samsung / iPhone / Redmi" value="${(data.brand||"")}" /></td>
        <td><input placeholder="A12 / 13 / Note 11 ..." value="${(data.model||"")}" /></td>
        <td><input placeholder="KBS / Original / OLED" value="${(data.quality||"")}" /></td>
        <td class="num"><input type="number" inputmode="decimal" step="0.01" min="0" value="${(data.price||0)}" /></td>
        <td class="num"><input type="number" inputmode="numeric" step="1" min="0" value="${(data.qty||0)}" /></td>
        <td class="num"><span class="line-sum">0</span></td>
        <td><button class="btn" style="padding:10px 12px" onclick="delRow(this)">–£–¥–∞–ª–∏—Ç—å</button></td>
      `;
      tr.querySelectorAll('input').forEach(inp=>{
        inp.style.width="100%";
        inp.style.padding="10px";
        inp.style.border="1px solid #2a3063";
        inp.style.borderRadius="10px";
        inp.style.background="#0a0d26";
        inp.style.color="#eaf0ff";
      });
      tbody.appendChild(tr);
      tr.querySelectorAll('input').forEach(inp=> inp.addEventListener('input', recalc));
      recalc();
    }

    function delRow(btn){
      btn.closest('tr').remove();
      recalc();
    }

    function recalc(){
      let total = 0, count = 0;
      tbody.querySelectorAll('tr').forEach(tr=>{
        const price = parseFloat(tr.querySelectorAll('input')[3].value || 0);
        const qty   = parseInt(tr.querySelectorAll('input')[4].value || 0, 10);
        const sum = +(price * qty).toFixed(2);
        tr.querySelector('.line-sum').textContent = sum;
        if (qty>0) count++;
        total += sum;
      });
      totalEl.textContent = total.toFixed(2);
      countEl.textContent = count;
    }

    async function saveOrder(){
      if (saveBtn.dataset.busy === '1') return;
      saveBtn.dataset.busy = '1';
      saveBtn.disabled = true;

      const payload = {
        date: document.getElementById('date')?.value || "",
        vendor: document.getElementById('vendor')?.value || "",
        currency: document.getElementById('currency')?.value || "TJS",
        note: document.getElementById('note')?.value || "",
        shipping_cost: 0,
        items: []
      };
      document.querySelectorAll('#items tbody tr').forEach(tr=>{
        const inputs = tr.querySelectorAll('input');
        payload.items.push({
          brand: inputs[0]?.value || "",
          model: inputs[1]?.value || "",
          quality: inputs[2]?.value || "",
          price: Number(inputs[3]?.value || 0),
          qty: Number(inputs[4]?.value || 0)
        });
      });

      try{
        const res = await fetch('/api/china-orders', {
          method:'POST',
          headers:{
            'Content-Type':'application/json',
            'X-Requested-With':'XMLHttpRequest'
          },
          credentials: 'same-origin',
          body: JSON.stringify(payload)
        });

        const ct = res.headers.get('content-type') || '';
        if (!ct.includes('application/json')) {
          toast('–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞. –í–æ–π–¥–∏—Ç–µ –∑–∞–Ω–æ–≤–æ.', 'err');
          window.location.href = '/login?next=/admin/china-orders';
          return;
        }

        const data = await res.json();
        if(res.ok && data.ok){
          toast('‚úÖ –ó–∞–∫–∞–∑ —Å–æ—Ö—Ä–∞–Ω—ë–Ω! ‚Ññ ' + data.order.id + ' ¬∑ –ò—Ç–æ–≥: ' + data.order.total + ' ' + (data.order.currency||''));
          // –ø–æ –∂–µ–ª–∞–Ω–∏—é: –æ—á–∏—Å—Ç–∏—Ç—å —Ñ–æ—Ä–º—É
          // tbody.innerHTML=''; addRow(); recalc();
        }else{
          toast('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + (data.error || res.status), 'err');
        }
      }catch(err){
        toast('–°–µ—Ç—å/—Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: ' + err.message, 'err');
      } finally {
        saveBtn.dataset.busy = '0';
        saveBtn.disabled = false;
      }
    }

    addRow();
    document.getElementById('date').valueAsDate = new Date();
  </script>
</body>
</html>
