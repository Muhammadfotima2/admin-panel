<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>–ó–∞–∫–∞–∑—ã –∏–∑ –ö–∏—Ç–∞—è</title>
  <style>
    :root{
      --bg1:#0e0f1e; --bg2:#1a1d3a; --card:#141738; --stroke:#252b56;
      --txt:#eaf0ff; --muted:#a7b0e0; --grad1:#ff4d6d; --grad2:#ff9a3c;
      --radius:22px; --pad:clamp(12px,2.5vw,24px);
      --input-pad:12px; --gap:12px;
      --shadow:0 24px 60px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.05);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Ubuntu, sans-serif; color:var(--txt);
      background:
        radial-gradient(1200px 800px at 80% -10%, #ff4d6d22, transparent 60%),
        radial-gradient(900px 600px at -10% 110%, #ff9a3c22, transparent 60%),
        linear-gradient(180deg,var(--bg1),var(--bg2));
      padding:var(--pad);
      padding-left:calc(env(safe-area-inset-left) + var(--pad));
      padding-right:calc(env(safe-area-inset-right) + var(--pad));
      padding-top:calc(env(safe-area-inset-top) + var(--pad));
      padding-bottom:calc(env(safe-area-inset-bottom) + var(--pad));
      display:flex; justify-content:center;
    }
    .container{width:min(1100px, 100%)}

    .header{display:flex; flex-direction:column; align-items:center; text-align:center; gap:10px; margin-bottom:16px}
    .logo{width:64px; height:64px; border-radius:18px; display:grid; place-items:center; font-size:28px;
      background:linear-gradient(135deg,var(--grad1),var(--grad2));
      box-shadow:0 10px 24px rgba(255,154,60,.28), inset 0 -6px 10px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.2)}
    .header h1{margin:0; font-size:24px}
    .header .hint{margin:0; color:var(--muted); font-size:14px; max-width:70ch}

    .back-wrap{display:flex; justify-content:center; margin:10px 0 18px}
    .back-btn{
      display:inline-flex; align-items:center; gap:10px; padding:12px 16px; border:0; border-radius:14px; cursor:pointer;
      font-weight:800; color:#0b0e27; text-decoration:none;
      background:linear-gradient(135deg, #bfc7ff, #89f0ff);
      box-shadow:0 8px 18px rgba(137,240,255,.30), inset 0 -4px 8px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.25);
      white-space:nowrap;
    }

    .card{background:linear-gradient(180deg, var(--card), #0d1030); border:1px solid var(--stroke); border-radius:var(--radius); padding:16px; box-shadow:var(--shadow); margin-bottom:16px}

    .row{display:grid; gap:var(--gap); grid-template-columns: repeat(4, 1fr)}
    .field{display:flex; flex-direction:column; gap:6px}
    label{font-size:12px; color:#cdd4ff}
    input, select{
      padding:var(--input-pad); border-radius:14px; border:1px solid #2a3063; background:#0a0d26; color:var(--txt);
      box-shadow: inset 0 2px 6px rgba(0,0,0,.55), inset 0 1px 0 rgba(255,255,255,.05); outline:none; min-width:0
    }
    input:focus, select:focus{border-color:#ff6d5a; outline:2px solid #ff6d5a55; outline-offset:2px}

    .table-wrap{width:100%; overflow-x:auto; -webkit-overflow-scrolling:touch; scrollbar-width:thin}
    table{width:100%; border-collapse:separate; border-spacing:0 10px; min-width:720px}
    th{font-size:12px; color:#cdd4ff; text-align:left; padding:0 10px; white-space:nowrap}
    td{background:#0a0d26; border:1px solid #2a3063; color:var(--txt); padding:10px; border-left-width:1px; vertical-align:middle}
    tr td:first-child{border-radius:12px 0 0 12px}
    tr td:last-child{border-radius:0 12px 12px 0}
    .num{width:110px}
    .actions{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
    .btn{display:inline-block; padding:12px 16px; border:0; border-radius:14px; cursor:pointer; font-weight:800; color:#0b0e27;
      background:linear-gradient(135deg,var(--grad1),var(--grad2)); box-shadow:0 6px 14px rgba(255,154,60,.30), inset 0 -4px 8px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.25); white-space:nowrap}
    .btn:active{transform:translateY(2px)}
    .btn.secondary{background:linear-gradient(135deg,#6a5cff,#9a49ff); color:#fff}
    .chip{display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px; background:rgba(255,255,255,.06); border:1px solid #2a3063}
    .statuspill{display:inline-block; padding:4px 10px; border-radius:999px; font-weight:800; font-size:12px; background:#1bd5a6; color:#062d24}

    /* Toasts */
    .toasts{position:fixed; left:50%; bottom:20px; transform:translateX(-50%); display:flex; flex-direction:column; gap:10px; z-index:9999; width:min(92vw, 520px); pointer-events:none}
    .toast{pointer-events:auto; display:flex; align-items:center; gap:10px; padding:12px 16px; border-radius:14px; font-weight:700; background:linear-gradient(135deg,#24d39a,#2fb2ff); color:#071b1a;
      box-shadow:0 14px 40px rgba(0,0,0,.5), inset 0 1px 0 rgba(255,255,255,.35); animation: slideUp .3s ease, fadeOut .3s ease 4.2s forwards}
    .toast.err{background:linear-gradient(135deg,#ff6b6b,#ff9a3c); color:#2e0606}
    .toast .x{margin-left:auto; background:transparent; border:0; font-size:18px; cursor:pointer; opacity:.7}
    @keyframes slideUp{from{transform:translate(-50%,10px); opacity:0} to{transform:translate(-50%,0); opacity:1}}
    @keyframes fadeOut{to{opacity:0; transform:translate(-50%,8px)}}

    /* Modal */
    .modal{position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; z-index:9998; padding:20px}
    .modal.open{display:flex}
    .modal .box{width:min(800px,100%); background:linear-gradient(180deg,#1a1d3a,#12142c); border:1px solid #2a3063; border-radius:18px; box-shadow:var(--shadow); padding:16px}
    .modal .top{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px}
    .modal .close{border:0; background:#0a0d26; color:#fff; padding:8px 10px; border-radius:10px; cursor:pointer}

    /* Responsive */
    @media (max-width: 900px){ .row{grid-template-columns: 1fr 1fr} .num{width:auto} }
    @media (max-width: 520px){
      :root{ --radius:18px; --input-pad:10px }
      .row{grid-template-columns: 1fr}
      .card{ padding:12px }
      .header h1{font-size:22px}
      .header .hint{font-size:13px}
      table{ border-spacing:0 8px; min-width:640px }
      th{ font-size:11px; padding:0 8px }
      td{ padding:8px }
      .actions{flex-direction:column}
      .actions .btn{ width:100% }
      .back-btn{ padding:10px 14px; font-size:14px }
    }
    @media (max-width: 360px){ .logo{ width:56px; height:56px; font-size:24px } label{ font-size:11px } input, select{ font-size:14px } table{ min-width:580px } }
  </style>
</head>
<body>
  <div class="container">

    <!-- Header -->
    <div class="header">
      <div class="logo" aria-hidden="true">üá®üá≥</div>
      <h1>–ó–∞–∫–∞–∑—ã –∏–∑ –ö–∏—Ç–∞—è</h1>
      <p class="hint">–î–æ–±–∞–≤–ª—è–π—Ç–µ –ø–æ–∑–∏—Ü–∏–∏ –∑–∞–∫–∞–∑–∞: –º–æ–¥–µ–ª—å, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ, —Ü–µ–Ω–∞ ‚Äî —Å—É–º–º–∞ —Å—á–∏—Ç–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</p>
    </div>

    <div class="back-wrap">
      <a class="back-btn" href="/admin/products">‚Üê –ù–∞–∑–∞–¥ –≤ –∞–¥–º–∏–Ω–∫—É</a>
    </div>

    <!-- –®–∞–ø–∫–∞ –∑–∞–∫–∞–∑–∞ -->
    <div class="card">
      <div class="row">
        <div class="field">
          <label for="date">–î–∞—Ç–∞</label>
          <input id="date" type="date">
        </div>
        <div class="field">
          <label for="vendor">–ü–æ—Å—Ç–∞–≤—â–∏–∫</label>
          <input id="vendor" placeholder="Shenzhen ...">
        </div>
        <div class="field">
          <label for="currency">–í–∞–ª—é—Ç–∞</label>
          <select id="currency">
            <option value="TJS">TJS</option>
            <option value="CNY">CNY</option>
            <option value="USD">USD</option>
          </select>
        </div>
        <div class="field">
          <label for="note">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
          <input id="note" placeholder="–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ">
        </div>
      </div>
    </div>

    <!-- –¢–∞–±–ª–∏—Ü–∞ –ø–æ–∑–∏—Ü–∏–π -->
    <div class="card">
      <div class="table-wrap">
        <table id="items">
          <thead>
            <tr>
              <th>–ë—Ä–µ–Ω–¥</th>
              <th>–ú–æ–¥–µ–ª—å</th>
              <th>–ö–∞—á–µ—Å—Ç–≤–æ</th>
              <th class="num">–¶–µ–Ω–∞</th>
              <th class="num">–ö–æ–ª-–≤–æ</th>
              <th class="num">–°—É–º–º–∞</th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="actions">
        <button class="btn" onclick="addRow()">Ôºã –î–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é</button>
        <button class="btn" id="saveBtn" onclick="saveOrder()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–∫–∞–∑</button>
      </div>
    </div>

    <!-- –ò—Ç–æ–≥–∏ -->
    <div class="card">
      <div class="totals">
        <div>–í—Å–µ–≥–æ –ø–æ–∑–∏—Ü–∏–π: <b id="count">0</b></div>
        <div class="sum">–ò—Ç–æ–≥–æ: <span id="total">0</span> <span id="cur">TJS</span></div>
      </div>
    </div>

    <!-- –ü–∞–Ω–µ–ª—å —Ñ–∏–ª—å—Ç—Ä–æ–≤ –∏ —ç–∫—Å–ø–æ—Ä—Ç -->
    <div class="card">
      <div class="actions" style="justify-content:space-between; gap:12px">
        <div style="display:flex; flex-wrap:wrap; gap:10px">
          <input id="filterQ" placeholder="–ü–æ–∏—Å–∫: –ø–æ—Å—Ç–∞–≤—â–∏–∫ / ID" />
          <select id="filterStatus">
            <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
            <option>New</option>
            <option>Confirmed</option>
            <option>Paid</option>
            <option>Shipped</option>
            <option>Cancelled</option>
          </select>
          <input id="filterFrom" type="date" />
          <input id="filterTo" type="date" />
          <button class="btn secondary" onclick="loadOrders()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä</button>
        </div>
        <div>
          <a class="btn" href="/api/china-orders/export.csv">üì• –≠–∫—Å–ø–æ—Ä—Ç CSV</a>
        </div>
      </div>
      <div class="actions" id="agg" style="gap:10px; margin-top:10px"></div>
    </div>

    <!-- –°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—ã -->
    <div class="card">
      <h2 style="margin:0 0 12px; font-size:18px">–°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—ã</h2>
      <div class="table-wrap">
        <table id="ordersTable">
          <thead>
            <tr>
              <th>ID</th>
              <th>–î–∞—Ç–∞</th>
              <th>–ü–æ—Å—Ç–∞–≤—â–∏–∫</th>
              <th>–í–∞–ª—é—Ç–∞</th>
              <th>–ü–æ–∑–∏—Ü–∏–∏</th>
              <th>–ò—Ç–æ–≥</th>
              <th>–°—Ç–∞—Ç—É—Å</th>
              <th></th>
            </tr>
          </thead>
          <tbody><!-- –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è JS --></tbody>
        </table>
      </div>
    </div>

  </div>

  <!-- Toasts -->
  <div class="toasts" id="toasts"></div>

  <!-- Modal details -->
  <div class="modal" id="modal">
    <div class="box">
      <div class="top">
        <h3 id="mTitle" style="margin:0">–î–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞</h3>
        <button class="close" onclick="closeModal()">√ó</button>
      </div>
      <div id="mBody"></div>
    </div>
  </div>

  <script>
    const tbody = document.querySelector('#items tbody');
    const totalEl = document.getElementById('total');
    const countEl = document.getElementById('count');
    const curEl = document.getElementById('cur');
    const currencySel = document.getElementById('currency');
    const saveBtn = document.getElementById('saveBtn');
    const toasts = document.getElementById('toasts');
    const ordersTbody = document.querySelector('#ordersTable tbody');
    const agg = document.getElementById('agg');

    const filterQ = document.getElementById('filterQ');
    const filterStatus = document.getElementById('filterStatus');
    const filterFrom = document.getElementById('filterFrom');
    const filterTo = document.getElementById('filterTo');

    // –ö—ç—à –∑–∞–∫–∞–∑–æ–≤ –¥–ª—è –º–æ–¥–∞–ª–∫–∏ "–î–µ—Ç–∞–ª–∏"
    let ORDERS_CACHE = [];

    function toast(msg, type='ok'){
      const el = document.createElement('div');
      el.className = 'toast' + (type==='err' ? ' err' : '');
      el.innerHTML = `<span>${msg}</span><button class="x" onclick="this.parentElement.remove()">√ó</button>`;
      toasts.appendChild(el);
      setTimeout(()=> el.remove(), 4500);
    }

    const DRAFT_KEY = 'chinaOrderDraft';
    function writeDraft(){
      const draft = {
        date: v('date'), vendor: v('vendor'), currency: v('currency'), note: v('note'),
        items: Array.from(tbody.querySelectorAll('tr')).map(tr=>{
          const inputs = tr.querySelectorAll('input');
          return {brand:inputs[0].value, model:inputs[1].value, quality:inputs[2].value, price:+inputs[3].value||0, qty:+inputs[4].value||0}
        })
      };
      localStorage.setItem(DRAFT_KEY, JSON.stringify(draft));
    }
    function loadDraft(){
      try{
        const d = JSON.parse(localStorage.getItem(DRAFT_KEY) || 'null');
        if (!d) return;
        s('date', d.date||'');
        s('vendor', d.vendor||'');
        s('currency', d.currency||'TJS');
        s('note', d.note||'');
        tbody.innerHTML = '';
        (d.items && d.items.length ? d.items : [{}]).forEach(addRow);
        recalc();
      }catch{}
    }
    function v(id){ return document.getElementById(id)?.value || '' }
    function s(id,val){ const el=document.getElementById(id); if(el) el.value=val }

    currencySel.addEventListener('change', ()=> curEl.textContent = currencySel.value);

    function addRow(data={}){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input placeholder="Samsung / iPhone / Redmi" value="${(data.brand||"")}" /></td>
        <td><input placeholder="A12 / 13 / Note 11 ..." value="${(data.model||"")}" /></td>
        <td><input placeholder="KBS / Original / OLED" value="${(data.quality||"")}" /></td>
        <td class="num"><input type="number" inputmode="decimal" step="0.01" min="0" value="${(data.price||0)}" /></td>
        <td class="num"><input type="number" inputmode="numeric" step="1" min="0" value="${(data.qty||0)}" /></td>
        <td class="num"><span class="line-sum">0</span></td>
        <td><button class="btn" style="padding:10px 12px" onclick="delRow(this)">–£–¥–∞–ª–∏—Ç—å</button></td>
      `;
      tr.querySelectorAll('input').forEach(inp=>{
        Object.assign(inp.style,{width:"100%",padding:"10px",border:"1px solid #2a3063",borderRadius:"10px",background:"#0a0d26",color:"#eaf0ff"});
        inp.addEventListener('input', ()=>{ recalc(); writeDraft(); });
      });
      tbody.appendChild(tr);
      recalc(); writeDraft();
    }
    function delRow(btn){ btn.closest('tr').remove(); recalc(); writeDraft(); }

    function recalc(){
      let total = 0, count = 0;
      tbody.querySelectorAll('tr').forEach(tr=>{
        const price = parseFloat(tr.querySelectorAll('input')[3].value || 0);
        const qty   = parseInt(tr.querySelectorAll('input')[4].value || 0, 10);
        const sum = +(price * qty).toFixed(2);
        tr.querySelector('.line-sum').textContent = sum;
        if (qty>0) count++; total += sum;
      });
      totalEl.textContent = total.toFixed(2);
      countEl.textContent = count;
    }

    async function saveOrder(){
      if (saveBtn.dataset.busy === '1') return;
      saveBtn.dataset.busy = '1'; saveBtn.disabled = true;

      const payload = {
        date: v('date'), vendor: v('vendor'), currency: v('currency') || "TJS", note: v('note'), shipping_cost: 0,
        items: Array.from(tbody.querySelectorAll('tr')).map(tr=>{
          const inputs = tr.querySelectorAll('input');
          return {brand:inputs[0].value, model:inputs[1].value, quality:inputs[2].value, price:+inputs[3].value||0, qty:+inputs[4].value||0}
        })
      };

      try{
        const res = await fetch('/api/china-orders', {
          method:'POST',
          headers:{'Content-Type':'application/json','X-Requested-With':'XMLHttpRequest'},
          credentials:'same-origin',
          body: JSON.stringify(payload)
        });
        const ct = res.headers.get('content-type')||'';
        if(!ct.includes('application/json')){ toast('–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞. –í–æ–π–¥–∏—Ç–µ –∑–∞–Ω–æ–≤–æ.', 'err'); location.href='/login?next=/admin/china-orders'; return; }
        const data = await res.json();
        if(res.ok && data.ok){
          toast('‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ: ' + data.order.id + ' ¬∑ ' + data.order.total + ' ' + (data.order.currency||'')); 
          localStorage.removeItem(DRAFT_KEY);
          loadOrders();
        }else{
          toast('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + (data.error || res.status), 'err');
        }
      }catch(e){ toast('–°–µ—Ç—å/—Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: ' + e.message, 'err'); }
      finally{ saveBtn.dataset.busy='0'; saveBtn.disabled=false; }
    }

    // --------- –°–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤ / —Ñ–∏–ª—å—Ç—Ä—ã / –∞–≥—Ä–µ–≥–∞—Ç—ã ----------
    async function loadOrders(){
      const params = new URLSearchParams();
      if (filterQ.value.trim()) params.set('q', filterQ.value.trim());
      if (filterStatus.value) params.set('status', filterStatus.value);
      if (filterFrom.value) params.set('date_from', filterFrom.value);
      if (filterTo.value) params.set('date_to', filterTo.value);

      try{
        const resList = await fetch('/api/china-orders?'+params.toString(), {headers:{'X-Requested-With':'XMLHttpRequest'}, credentials:'same-origin'});
        const obj = await resList.json();
        const list = Array.isArray(obj) ? obj : (obj.items || []);
        ORDERS_CACHE = Array.isArray(list) ? list : [];
        renderOrders(ORDERS_CACHE);

        // totals ‚Äî –Ω–µ–æ–±—è–∑–∞—Ç–µ–ª–µ–Ω; –±–µ–∑–æ–ø–∞—Å–Ω–æ –ø—Ä–æ–±—É–µ–º
        try {
          const resTotals = await fetch('/api/china-orders/totals', {headers:{'X-Requested-With':'XMLHttpRequest'}, credentials:'same-origin'});
          if (resTotals.ok && (resTotals.headers.get('content-type')||'').includes('application/json')) {
            const totals = await resTotals.json();
            renderAgg(totals);
          } else {
            renderAgg(null);
          }
        } catch { renderAgg(null); }

      }catch(e){
        toast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞', 'err');
      }
    }

    function renderAgg(totals){
      agg.innerHTML = '';
      if (totals?.sums){
        for (const [cur,sum] of Object.entries(totals.sums)){
          const el = document.createElement('div');
          el.className='chip';
          el.textContent = `–°—É–º–º–∞ ${cur}: ${sum}`;
          agg.appendChild(el);
        }
      }
      if (totals?.statuses){
        for (const [st,cnt] of Object.entries(totals.statuses)){
          const el = document.createElement('div');
          el.className='chip';
          el.textContent = `${st}: ${cnt}`;
          agg.appendChild(el);
        }
      }
    }

    function renderOrders(list){
      ordersTbody.innerHTML = '';
      (list||[]).slice().reverse().forEach(o=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${o.id}</td>
          <td>${o.date||''}</td>
          <td>${o.vendor||''}</td>
          <td>${o.currency||''}</td>
          <td>${o.positions|| (o.items||[]).length}</td>
          <td>${o.total||0}</td>
          <td>
            <select data-oid="${o.id}" onchange="changeStatus(this)">
              ${["New","Confirmed","Paid","Shipped","Cancelled"].map(s=>`<option ${s===o.status?'selected':''}>${s}</option>`).join('')}
            </select>
            <span class="statuspill" style="margin-left:8px">${o.status||'New'}</span>
          </td>
          <td>
            <button class="btn secondary" style="padding:8px 12px" onclick="showDetails('${o.id}')">–î–µ—Ç–∞–ª–∏</button>
            <button class="btn" style="padding:8px 12px" onclick="deleteOrder('${o.id}')">–£–¥–∞–ª–∏—Ç—å</button>
          </td>
        `;
        ordersTbody.appendChild(tr);
      });
    }

    async function changeStatus(sel){
      const id = sel.getAttribute('data-oid'); const st = sel.value;
      try{
        const res = await fetch(`/api/china-orders/${id}/status`, {
          method:'PUT', headers:{'Content-Type':'application/json','X-Requested-With':'XMLHttpRequest'},
          credentials:'same-origin', body: JSON.stringify({status: st})
        });
        const data = await res.json();
        if(res.ok && data.ok){ toast('–°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª—ë–Ω'); loadOrders(); }
        else{ toast('–û—à–∏–±–∫–∞ —Å—Ç–∞—Ç—É—Å–∞: '+(data.error||res.status), 'err'); }
      }catch(e){ toast('–°–µ—Ç—å: '+e.message, 'err'); }
    }

    async function deleteOrder(id){
      if(!confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–∫–∞–∑?')) return;
      try{
        const res = await fetch(`/api/china-orders/${id}`, {method:'DELETE', headers:{'X-Requested-With':'XMLHttpRequest'}, credentials:'same-origin'});
        const data = await res.json();
        if(res.ok && data.ok){ toast('–£–¥–∞–ª–µ–Ω–æ'); loadOrders(); }
        else{ toast('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: '+(data.error||res.status), 'err'); }
      }catch(e){ toast('–°–µ—Ç—å: '+e.message, 'err'); }
    }

    // ---------- –ú–æ–¥–∞–ª: –¥–µ—Ç–∞–ª–∏ (–±–µ—Ä—ë–º –∏–∑ –∫—ç—à–∞, –±–µ–∑ /api/china-orders/<id>) ----------
    function showDetails(id){
      const o = ORDERS_CACHE.find(x => String(x.id) === String(id));
      if(!o){ toast('–ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω', 'err'); return; }
      document.getElementById('mTitle').textContent =
        `–ó–∞–∫–∞–∑ ${o.id} ‚Ä¢ ${o.vendor||''} ‚Ä¢ ${o.date||''} ‚Ä¢ ${o.total||0} ${o.currency||''}`;
      document.getElementById('mBody').innerHTML = `
        <div class="table-wrap">
          <table>
            <thead><tr><th>–ë—Ä–µ–Ω–¥</th><th>–ú–æ–¥–µ–ª—å</th><th>–ö–∞—á–µ—Å—Ç–≤–æ</th><th class="num">–¶–µ–Ω–∞</th><th class="num">–ö–æ–ª-–≤–æ</th><th class="num">–°—É–º–º–∞</th></tr></thead>
            <tbody>
              ${(o.items||[]).map(it=>{
                const sum = ((+it.price||0) * (+it.qty||0)).toFixed(2);
                return `<tr><td>${it.brand||''}</td><td>${it.model||''}</td><td>${it.quality||''}</td><td>${it.price||0}</td><td>${it.qty||0}</td><td>${sum}</td></tr>`
              }).join('')}
            </tbody>
          </table>
        </div>
        <div style="margin-top:10px" class="chip">–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: ${o.note||'‚Äî'}</div>
      `;
      openModal();
    }

    const modal = document.getElementById('modal');
    function openModal(){ modal.classList.add('open') }
    function closeModal(){ modal.classList.remove('open') }
    modal.addEventListener('click', e=>{ if(e.target===modal) closeModal() })

    // --------- —Å—Ç–∞—Ä—Ç ---------
    function firstRow(){ if(!tbody.querySelector('tr')) addRow() }
    addRow(); s('date', new Date().toISOString().slice(0,10)); loadDraft(); firstRow(); loadOrders();

    // –ø–∏—Å–∞—Ç—å —á–µ—Ä–Ω–æ–≤–∏–∫ –ø—Ä–∏ –ª—é–±–æ–º –≤–≤–æ–¥–µ –≤ —Ñ–æ—Ä–º–µ –∑–∞–∫–∞–∑–∞
    document.addEventListener('input', (e)=>{ if (e.target.closest('#items') || e.target.id==='date' || e.target.id==='vendor' || e.target.id==='currency' || e.target.id==='note'){ writeDraft(); } });
  </script>
</body>
</html>
