{% extends "base.html" %}
{% block title %}–°–∫–ª–∞–¥ ‚Äî –ê–¥–º–∏–Ω{% endblock %}
{% block content %}
<style>
@import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap");
:root{--bg1:#1a1031;--bg2:#2a1452;--bg3:#30164f;--panel:#22143dbd;--panel-strong:#1f1237;--ink:#efeaff;--muted:#c9c3ef;
--ring:rgba(123,62,255,.35);--shadow-d:rgba(0,0,0,.45);--shadow-l:rgba(255,255,255,.06);
--g-blue:linear-gradient(135deg,#7a35ff 0%,#4db5ff 100%);--g-orange:linear-gradient(135deg,#ff7a18 0%,#ff3d85 100%);
--g-green:linear-gradient(135deg,#31d67b 0%,#31e1d4 100%);--g-red:linear-gradient(135deg,#ff3b4a 0%,#ff7a18 100%)}
body{font-family:"Inter",system-ui,-apple-system,Segoe UI,Roboto,sans-serif;color:var(--ink);
background:radial-gradient(1200px 700px at 15% -10%, #4a1caf66 0%, transparent 60%),
radial-gradient(1200px 700px at 105% 10%, #ff3d8566 0%, transparent 60%),
linear-gradient(180deg, var(--bg3), var(--bg1));}
.page{max-width:1200px;margin:24px auto;padding:0 14px}
.page-head{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:16px}
.page-head h1{margin:0;font-size:32px;font-weight:800}
.input{width:100%;border:none;outline:none;padding:12px 16px;border-radius:16px;color:var(--ink);background:#23153fbd;
box-shadow:inset 6px 6px 12px rgba(0,0,0,.45), inset -6px -6px 14px rgba(255,255,255,.06), 8px 8px 22px rgba(0,0,0,.35), -6px -6px 18px rgba(255,255,255,.04)}
.input.small{padding:8px 10px;border-radius:14px}
.btn{border:none;cursor:pointer;color:#fff;font-weight:700;padding:11px 16px;border-radius:16px;background:#2a2146;
box-shadow:8px 8px 18px var(--shadow-d), -6px -6px 16px var(--shadow-l);transition:.15s transform,.2s filter}
.btn:hover{transform:translateY(-1px);filter:saturate(1.05)}.btn:active{transform:translateY(1px)}
.btn.pill{border-radius:999px}.btn.primary{background:var(--g-blue)}.btn.success{background:var(--g-green)}.btn.warn{background:var(--g-orange)}
.toolbar{display:grid;grid-template-columns:1fr 220px 220px;gap:10px;margin-bottom:14px}
@media (max-width:900px){.toolbar{grid-template-columns:1fr 1fr}}
.table-wrap{background:var(--panel);border-radius:22px;padding:10px;box-shadow:12px 12px 28px var(--shadow-d), -10px -10px 24px var(--shadow-l)}
.tbl{width:100%;border-collapse:separate;border-spacing:0 10px}
.tbl thead th{font-weight:600;text-align:left;padding:12px 14px;color:#d8d2ff}
.tbl tbody tr{background:var(--panel-strong);color:var(--ink);box-shadow:6px 6px 14px var(--shadow-d), -6px -6px 16px var(--shadow-l)}
.tbl tbody td{padding:12px 14px}
.tbl tbody td:first-child{border-top-left-radius:16px;border-bottom-left-radius:16px}
.tbl tbody td:last-child{border-top-right-radius:16px;border-bottom-right-radius:16px}
.tbl .num{text-align:right}.badge{display:inline-block;padding:6px 10px;border-radius:999px;font-size:12px;background:#2a2146;color:#fff}
.badge.red{background:var(--g-red)}.row-actions{display:flex;gap:8px}
.row-actions .icon{background:#281548;color:#fff;padding:9px 10px;border-radius:12px;cursor:pointer;box-shadow:6px 6px 14px var(--shadow-d), -6px -6px 14px var(--shadow-l)}
.row-actions .icon:hover{transform:translateY(-1px)}.small{font-size:14px}
</style>

<div class="page">
  <header class="page-head">
    <h1>üè≠ –°–∫–ª–∞–¥</h1>
    <div class="actions"><button id="btn-save-all" class="btn pill success">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å–µ</button></div>
  </header>

  <section class="toolbar">
    <input id="q" class="input" placeholder="–ü–æ–∏—Å–∫: –±—Ä–µ–Ω–¥ / –º–æ–¥–µ–ª—å / –∫–∞—á–µ—Å—Ç–≤–æ / —Ç–µ–≥–∏">
    <select id="onlyCritical" class="input">
      <option value="0">–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –≤—Å–µ</option>
      <option value="1" selected>–¢–æ–ª—å–∫–æ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ (&lt; 5)</option>
    </select>
    <select id="brand" class="input">
      <option value="">–ë—Ä–µ–Ω–¥ (–≤—Å–µ)</option>
      <option>iPhone</option><option>Samsung</option><option>Redmi</option><option>Realme</option>
      <option>Oppo</option><option>Vivo</option><option>Huawei</option><option>Honor</option>
      <option>Tecno</option><option>Infinix</option><option>ZTE</option><option>WIKO</option>
    </select>
  </section>

  <section class="table-wrap">
    <table class="tbl" id="tbl">
      <thead>
        <tr>
          <th>ID</th><th>–ë—Ä–µ–Ω–¥</th><th>–ú–æ–¥–µ–ª—å</th><th>–ö–∞—á–µ—Å—Ç–≤–æ</th>
          <th class="num">–û—Å—Ç–∞—Ç–æ–∫</th><th class="num small">–ù–æ–≤—ã–π –æ—Å—Ç–∞—Ç–æ–∫</th><th>–î–µ–π—Å—Ç–≤–∏—è</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>
  </section>
</div>

<script>
(async function(){
  const q = document.getElementById('q');
  const onlyCritical = document.getElementById('onlyCritical');
  const brand = document.getElementById('brand');
  const rowsEl = document.getElementById('rows');
  const saveAllBtn = document.getElementById('btn-save-all');

  let all = [];
  let edited = new Map();
  const toNum = v => isNaN(+v) ? 0 : +v;

  async function load(){
    const r = await fetch('/api/products');
    all = await r.json();
    render();
  }

  function render(){
    const term = (q.value||'').trim().toLowerCase();
    const onlyCrit = onlyCritical.value === '1';
    const brandFilter = (brand.value||'').toLowerCase();

    let items = all.slice().filter(p=>{
      const hay = [p.brand,p.model,p.quality,(p.tags||[]).join(' ')].join(' ').toLowerCase();
      if (term && !hay.includes(term)) return false;
      if (brandFilter && (p.brand||'') !== brandFilter) return false;
      if (onlyCrit && toNum(p.stock) >= 5) return false;
      return true;
    });

    rowsEl.innerHTML = items.map(p=>{
      const crit = toNum(p.stock) < 5;
      const val = edited.has(p.id) ? edited.get(p.id) : (p.stock||0);
      return `
        <tr data-id="${p.id}">
          <td title="${p.id}">${(p.id||'').slice(0,7)}</td>
          <td>${(p.brand||'').replace(/^./, c=>c.toUpperCase())}</td>
          <td>${p.model||''}</td>
          <td>${p.quality||''}</td>
          <td class="num">${crit ? `<span class="badge red">${p.stock||0}</span>` : (p.stock||0)}</td>
          <td class="num"><input class="input small" type="number" step="1" min="0" value="${val}" style="width:110px"/></td>
          <td class="row-actions"><button class="icon" data-act="save-one" title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å">üíæ</button></td>
        </tr>`;
    }).join('');
  }

  rowsEl.addEventListener('input', (e)=>{
    const tr = e.target.closest('tr');
    if (tr && e.target.matches('input[type="number"]')){
      edited.set(tr.dataset.id, toNum(e.target.value));
    }
  });

  rowsEl.addEventListener('click', async (e)=>{
    const btn = e.target.closest('[data-act="save-one"]');
    if (!btn) return;
    const tr = btn.closest('tr');
    const id = tr.dataset.id;
    const input = tr.querySelector('input[type="number"]');
    const newStock = toNum(input.value);
    try{
      const r = await fetch('/api/stock-batch', { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify([{id, stock:newStock}]) });
      const data = await r.json();
      if (!r.ok || data.ok === false) throw new Error(data.error || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
      const p = all.find(x=>x.id===id); if (p) p.stock = newStock;
      edited.delete(id); render();
    }catch(err){ alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å: ' + err.message); }
  });

  saveAllBtn.addEventListener('click', async ()=>{
    if (edited.size === 0){ alert('–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π.'); return; }
    const payload = Array.from(edited.entries()).map(([id, stock])=>({id, stock}));
    try{
      const r = await fetch('/api/stock-batch', { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
      const data = await r.json();
      if (!r.ok || data.ok === false) throw new Error(data.error || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
      for (const {id, stock} of payload){ const p = all.find(x=>x.id===id); if (p) p.stock = stock; }
      edited.clear(); render(); alert('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ: ' + data.updated);
    }catch(err){ alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å: ' + err.message); }
  });

  q.addEventListener('input', render);
  onlyCritical.addEventListener('change', render);
  brand.addEventListener('change', render);
  await load();
})();
</script>
{% endblock %}
