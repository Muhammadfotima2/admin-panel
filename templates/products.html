{% extends "base.html" %}
{% block title %}–¢–æ–≤–∞—Ä—ã{% endblock %}
{% block content %}

<h1>üì¶ –¢–æ–≤–∞—Ä—ã</h1>

<!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è -->
<div style="margin:16px 0; padding:16px; border:1px solid #e5e7eb; border-radius:12px;">
  <h2>‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</h2>
  <form id="addForm">
    <div style="display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:12px;">
      <input name="brand" placeholder="–ë—Ä–µ–Ω–¥ (slug, –Ω–∞–ø—Ä–∏–º–µ—Ä: samsung)" required>
      <input name="model" placeholder="–ú–æ–¥–µ–ª—å (–Ω–∞–ø—Ä–∏–º–µ—Ä: Galaxy A10)" required>
      <input name="quality" placeholder="–ö–∞—á–µ—Å—Ç–≤–æ (Original / Incell)">
      <input name="price" type="number" step="0.01" placeholder="–¶–µ–Ω–∞" required>
      <input name="currency" value="TJS" placeholder="–í–∞–ª—é—Ç–∞">
      <input name="vendor" placeholder="Brend / –ü–æ—Å—Ç–∞–≤—â–∏–∫ (–Ω–∞–ø—Ä–∏–º–µ—Ä: KBS)">
      <input name="photo" type="url" placeholder="URL —Ñ–æ—Ç–æ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
      <input name="stock" type="number" placeholder="–û—Å—Ç–∞—Ç–æ–∫ (–æ–ø—Ü.)">
      <input name="type" placeholder="–ë–µ–π–¥–∂ (–Ω–∞–ø—Ä–∏–º–µ—Ä: OLED, Copy AAA) (–æ–ø—Ü.)">
      <input name="tags" placeholder="–¢–µ–≥–∏ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é (–æ–ø—Ü.)">
    </div>
    <div style="margin-top:10px;">
      <textarea name="specs" rows="5" style="width:100%;"
        placeholder='–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ (JSON), –ø—Ä–∏–º–µ—Ä:
{
  "–î–∏–∞–≥–æ–Ω–∞–ª—å": "6.2\"",
  "–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å": "SM-A105",
  "–ì–∞—Ä–∞–Ω—Ç–∏—è": "14 –¥–Ω–µ–π"
}'></textarea>
    </div>
    <button type="submit" style="margin-top:10px;">–î–æ–±–∞–≤–∏—Ç—å</button>
  </form>
</div>

<!-- –¢–∞–±–ª–∏—Ü–∞ —Ç–æ–≤–∞—Ä–æ–≤ -->
<div style="overflow:auto;">
  <table border="1" cellpadding="8" cellspacing="0">
    <thead>
      <tr>
        <th>–ë—Ä–µ–Ω–¥</th>
        <th>–ú–æ–¥–µ–ª—å</th>
        <th>–ö–∞—á–µ—Å—Ç–≤–æ</th>
        <th>–¶–µ–Ω–∞</th>
        <th>–í–∞–ª—é—Ç–∞</th>
        <th>Vendor</th>
        <th>–§–æ—Ç–æ</th>
        <th>–ë–µ–π–¥–∂</th>
        <th>–û—Å—Ç–∞—Ç–æ–∫</th>
        <th>–ê–∫—Ç–∏–≤–µ–Ω</th>
        <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
      </tr>
    </thead>
    <tbody id="rows"></tbody>
  </table>
</div>

<script>
async function loadProducts() {
  const r = await fetch('/api/products');
  const items = await r.json();
  const tbody = document.getElementById('rows');
  tbody.innerHTML = '';
  items.forEach(p => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${p.brand || ''}</td>
      <td>${p.model || ''}</td>
      <td>${p.quality || ''}</td>
      <td>${p.price ?? ''}</td>
      <td>${p.currency || ''}</td>
      <td>${p.vendor || ''}</td>
      <td>${p.photo ? `<a href="${p.photo}" target="_blank">—Ñ–æ—Ç–æ</a>` : ''}</td>
      <td>${p.type || ''}</td>
      <td>${p.stock ?? 0}</td>
      <td>${p.active ? '‚úì' : '‚Äî'}</td>
      <td><button data-id="${p.id}" class="del">–£–¥–∞–ª–∏—Ç—å</button></td>
    `;
    tbody.appendChild(tr);
  });

  // delete
  document.querySelectorAll('button.del').forEach(btn => {
    btn.onclick = async () => {
      const id = btn.getAttribute('data-id');
      if (!confirm('–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä?')) return;
      const r = await fetch('/api/products/'+id, { method: 'DELETE' });
      const js = await r.json();
      if (js.ok) loadProducts();
      else alert('–û—à–∏–±–∫–∞: ' + (js.error || 'unknown'));
    };
  });
}

document.getElementById('addForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const f = e.target;

  let specsObj = {};
  const specsRaw = (f.specs.value || '').trim();
  if (specsRaw) {
    try { specsObj = JSON.parse(specsRaw); }
    catch (_) { alert('‚ùó specs –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤–∞–ª–∏–¥–Ω—ã–º JSON'); return; }
  }

  const payload = {
    brand: (f.brand.value || '').trim().toLowerCase(),
    model: (f.model.value || '').trim(),
    quality: (f.quality.value || '').trim(),
    price: Number(f.price.value || 0),
    currency: (f.currency.value || 'TJS').trim(),
    vendor: (f.vendor.value || '').trim(),
    photo: (f.photo.value || '').trim(),
    stock: Number(f.stock.value || 0),
    type: (f.type.value || '').trim(),
    tags: (f.tags.value || '').split(',').map(s => s.trim()).filter(Boolean),
    specs: specsObj,
    active: true,
  };

  const r = await fetch('/api/products', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify(payload)
  });
  const js = await r.json();
  if (r.ok) {
    alert('‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ');
    f.reset();
    loadProducts();
  } else {
    alert('‚ùå –û—à–∏–±–∫–∞: ' + (js.error || r.status));
  }
});

loadProducts();
</script>

{% endblock %}
