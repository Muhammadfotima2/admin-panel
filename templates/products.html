{% extends "base.html" %}
{% block content %}
<style>
/* === –°–ö–û–ü–ò–†–û–í–ê–ù–ù–´–ô/–ö–ê–°–¢–û–ú–ù–´–ô –°–¢–ò–õ–¨ –¢–û–õ–¨–ö–û –î–õ–Ø –≠–¢–û–ô –°–¢–†–ê–ù–ò–¶–´ === */
.products-admin{
  --bg1:#0b0b2b;
  --bg2:#1a0f3d;
  --glass:rgba(255,255,255,0.06);
  --stroke:rgba(255,255,255,0.08);
  --txt:#e9e7ff;
  --muted:#b9b4e6;
  --accent1:#ff6a00;
  --accent2:#ff00a8;
  --accent3:#6a5cff;
  --ok:#21d19f;
  --warn:#ffb020;
  --danger:#ff4d4d;
  --card-grad: linear-gradient(135deg, #ff7a00 0%, #ff2ea6 48%, #6a5cff 100%);
  --btn-grad: linear-gradient(135deg, #ff7a00 0%, #ff2ea6 100%);
  --btn-grad-purple: linear-gradient(135deg, #6a5cff 0%, #9a49ff 100%);
  --shadow-3d: 0 10px 30px rgba(0,0,0,0.55), 0 1px 0 rgba(255,255,255,0.03) inset;
  --radius: 14px;
  color:var(--txt);
  background:
    radial-gradient(1200px 600px at -10% -10%, #43126f66, transparent 60%),
    radial-gradient(900px 600px at 110% 10%, #0aa6ff22, transparent 60%),
    linear-gradient(160deg, var(--bg1), var(--bg2));
  border-radius: 18px;
  padding: 18px;
}

/* –í–µ—Ä—Ö—É—à–∫–∞ */
.products-admin .topbar{
  display:flex; align-items:center; gap:14px; margin-bottom:18px
}
.products-admin h1{margin:0 12px 0 0; font-size:26px; letter-spacing:.3px}

/* –ü–æ–∏—Å–∫ */
.products-admin .search{
  flex:1; display:flex; align-items:center; gap:12px; padding:12px 16px;
  border-radius:20px; border:1px solid var(--stroke);
  background:rgba(255,255,255,0.08);
  backdrop-filter: blur(10px);
  box-shadow:0 4px 10px rgba(0,0,0,.4);
}
.products-admin .search svg{width:20px; height:20px; fill:#cfcfea}
.products-admin .search input{
  width:100%; background:transparent; border:0; outline:none; color:var(--txt); font-size:14px;
}

/* –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π */
.products-admin .seg{
  display:flex; gap:10px; align-items:center;
  background:rgba(255,255,255,0.06); border:1px solid var(--stroke); border-radius:14px; padding:8px;
}
.products-admin .seg button{
  border:0; padding:10px 14px; border-radius:12px; color:#fff; font-weight:700; cursor:pointer;
  background:var(--btn-grad); box-shadow:var(--shadow-3d);
  transition: transform .18s ease, box-shadow .18s ease, background .18s ease;
}
.products-admin .seg button.secondary{background:var(--btn-grad-purple)}
.products-admin .seg button:hover{transform:scale(1.08); box-shadow:0 0 12px rgba(255,255,255,.35)}
.products-admin .seg button:active{transform:scale(0.94)}

/* –ü–∞–Ω–µ–ª—å/—Ç–∞–±–ª–∏—Ü–∞ */
.products-admin .panel{
  background:rgba(255,255,255,0.06); border:1px solid var(--stroke);
  border-radius:20px; padding:14px; box-shadow:var(--shadow-3d);
}
.products-admin table{width:100%; border-collapse:separate; border-spacing:0 10px; margin-top:8px}
.products-admin thead th{
  text-align:left; color:#dcd7ff; font-size:13px; font-weight:700; padding:10px 14px;
}
.products-admin .row{
  background:rgba(8,8,30,0.65);
  border:1px solid var(--stroke); border-radius:14px; overflow:hidden;
}
.products-admin .row td{padding:12px 14px; font-size:14px; color:#f1eeff; vertical-align:middle}

/* –¢–µ–≥–∏ –∫–∞—á–µ—Å—Ç–≤–∞ */
.products-admin .tag{
  display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; font-weight:700; font-size:12px;
  background:linear-gradient(135deg,#1bd5a6,#11b37f); color:#04251d; box-shadow: inset 0 -1px 0 rgba(255,255,255,.25);
}
.products-admin .tag.purple{background:linear-gradient(135deg,#836bff,#4c39ff); color:#0d0832}

/* –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏ –∫–Ω–æ–ø–∫–∏ */
.products-admin .qty{display:flex; align-items:center; gap:12px}
.products-admin .qty button{
  width:28px; height:28px; border-radius:10px; border:0; cursor:pointer;
  background:rgba(255,255,255,0.08); color:#fff;
  transition: transform .18s ease, box-shadow .18s ease, background .18s ease, color .18s ease;
}
.products-admin .qty button:hover{transform:scale(1.08); box-shadow:0 0 10px rgba(255,255,255,.25); background:var(--btn-grad)}
.products-admin .qty button:active{transform:scale(0.94)}

.products-admin .actions{display:flex; gap:8px}
.products-admin .iconbtn{
  width:34px; height:34px; border-radius:12px; border:1px solid var(--stroke);
  background:rgba(255,255,255,0.07); color:#fff; cursor:pointer;
  transition: transform .18s ease, box-shadow .18s ease, background .18s ease, color .18s ease;
}
.products-admin .iconbtn:hover{transform:scale(1.08); box-shadow:0 0 12px rgba(255,255,255,.35); background:var(--btn-grad)}
.products-admin .iconbtn:active{transform:scale(0.94)}

/* –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è ‚Äî –≤—ã–¥–≤–∏–∂–Ω–∞—è –ø–∞–Ω–µ–ª—å */
.products-admin .drawer{
  margin-top:16px; overflow:hidden; border-radius:16px; border:1px solid var(--stroke);
  background:rgba(255,255,255,0.06);
  max-height:0; transition:max-height .35s ease;
}
.products-admin .drawer.open{max-height:600px}
.products-admin .drawer .inner{padding:16px; display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:12px}
.products-admin .drawer label{font-size:13px; color:var(--muted)}
.products-admin .drawer input,
.products-admin .drawer textarea{
  width:100%; margin-top:6px; padding:10px 12px; border-radius:12px;
  background:rgba(255,255,255,0.08); border:1px solid var(--stroke); color:var(--txt);
  outline:none;
}
.products-admin .drawer textarea{min-height:96px}
.products-admin .drawer .row-span-2{grid-column: span 2}
.products-admin .drawer .btns{display:flex; gap:10px; margin-top:8px}
.products-admin .drawer .btns button{
  border:0; padding:10px 14px; border-radius:12px; color:#fff; font-weight:700; cursor:pointer;
  background:var(--btn-grad); box-shadow:var(--shadow-3d);
  transition: transform .18s ease;
}
.products-admin .drawer .btns button:active{transform:scale(.96)}

/* –§–æ—Ç–æ */
.products-admin .thumb{width:44px; height:44px; border-radius:10px; object-fit:cover; border:1px solid var(--stroke);}

/* –ü—É—Å—Ç–æ */
.products-admin .empty{padding:16px; color:var(--muted)}
</style>

<div class="products-admin">
  <!-- –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å -->
  <div class="topbar">
    <h1>üì¶ –¢–æ–≤–∞—Ä—ã</h1>

    <!-- –ü–æ–∏—Å–∫ -->
    <div class="search" role="search" aria-label="–ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤">
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <path d="M9.5 3a6.5 6.5 0 0 1 5.19 10.45l5.43 5.43-1.42 1.42-5.43-5.43A6.5 6.5 0 1 1 9.5 3m0 2a4.5 4.5 0 1 0 0 9 4.5 4.5 0 0 0 0-9z"/>
      </svg>
      <input id="q" placeholder="–ü–æ–∏—Å–∫: –±—Ä–µ–Ω–¥ / –º–æ–¥–µ–ª—å / –∫–∞—á–µ—Å—Ç–≤–æ / —Ç–µ–≥–∏" />
    </div>

    <!-- –ö–Ω–æ–ø–∫–∏ -->
    <div class="seg" role="group" aria-label="–î–µ–π—Å—Ç–≤–∏—è">
      <button type="button" id="btnImport">‚á™ –ò–º–ø–æ—Ä—Ç</button>
      <button type="button" class="secondary" id="btnExport">‚§ì –≠–∫—Å–ø–æ—Ä—Ç</button>
      <button type="button" id="btnAdd">Ôºã –î–æ–±–∞–≤–∏—Ç—å</button>
    </div>
  </div>

  <!-- –í—ã–¥–≤–∏–∂–Ω–∞—è —Ñ–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è -->
  <section class="drawer" id="drawer">
    <form id="addForm" accept-charset="UTF-8">
      <div class="inner">
        <div>
          <label>–ë—Ä–µ–Ω–¥
            <input name="brand" required placeholder="samsung / iphone / xiaomi">
          </label>
        </div>
        <div>
          <label>–ú–æ–¥–µ–ª—å
            <input name="model" required placeholder="A10 / 11 / Redmi 9">
          </label>
        </div>
        <div>
          <label>–ö–∞—á–µ—Å—Ç–≤–æ
            <input name="quality" placeholder="KBS / Original">
          </label>
        </div>
        <div>
          <label>–¶–µ–Ω–∞
            <input name="price" type="number" step="0.01" placeholder="0">
          </label>
        </div>
        <div>
          <label>–í–∞–ª—é—Ç–∞
            <input name="currency" value="TJS">
          </label>
        </div>
        <div>
          <label>Vendor
            <input name="vendor" placeholder="–û–ø—Ç-–ø–æ—Å—Ç–∞–≤—â–∏–∫">
          </label>
        </div>
        <div>
          <label>–§–æ—Ç–æ (URL)
            <input name="photo" placeholder="https://...jpg">
          </label>
        </div>
        <div>
          <label>–û—Å—Ç–∞—Ç–æ–∫
            <input name="stock" type="number" value="0">
          </label>
        </div>
        <div>
          <label>–¢–∏–ø
            <input name="type" placeholder="OLED / IPS">
          </label>
        </div>
        <div>
          <label>–¢—ç–≥–∏ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)
            <input name="tags" placeholder="A-series, –Ω–æ–≤—ã–π, —Ö–∏—Ç">
          </label>
        </div>
        <div class="row-span-2">
          <label>–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ (specs)
            <textarea name="specs" placeholder='–î–∏–∞–≥–æ–Ω–∞–ª—å: 6.1"
–ú–∞—Ç—Ä–∏—Ü–∞: OLED
–ì–∞—Ä–∞–Ω—Ç–∏—è: 15 –¥–Ω–µ–π'></textarea>
          </label>
        </div>
      </div>
      <div class="btns" style="padding:0 16px 16px">
        <button type="submit">‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button type="button" id="btnCancel">‚úñ –û—Ç–º–µ–Ω–∞</button>
      </div>
    </form>
  </section>

  <!-- –¢–∞–±–ª–∏—Ü–∞ -->
  <section class="panel">
    <table class="table" aria-label="–¢–æ–≤–∞—Ä—ã">
      <thead>
        <tr>
          <th>ID</th>
          <th>–ë—Ä–µ–Ω–¥</th>
          <th>–ú–æ–¥–µ–ª—å</th>
          <th>–ö–∞—á–µ—Å—Ç–≤–æ</th>
          <th>–¶–µ–Ω–∞</th>
          <th>–û—Å—Ç.</th>
          <th>–î–µ–π—Å—Ç–≤–∏—è</th>
        </tr>
      </thead>
      <tbody id="tbody">
        <tr><td colspan="7" class="empty">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</td></tr>
      </tbody>
    </table>
  </section>
</div>

<script>
// ===== –ü–æ–º–æ—â–Ω–∏–∫–∏ =====
const $ = (sel, root=document) => root.querySelector(sel);
const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

function specsText(text) {
  return (text || '').trim();
}

function normalizeStr(s) {
  return (s || '').toString().trim().toLowerCase();
}

// ===== –†–µ–Ω–¥–µ—Ä —Ç–∞–±–ª–∏—Ü—ã =====
let PRODUCTS = [];

function renderRows(list) {
  const tb = $('#tbody');
  if (!list.length) {
    tb.innerHTML = `<tr><td colspan="7" class="empty">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</td></tr>`;
    return;
  }
  tb.innerHTML = '';
  list.forEach(p => {
    const tr = document.createElement('tr');
    tr.className = 'row';
    tr.innerHTML = `
      <td>${p.id.slice(0,8)}</td>
      <td>${(p.brand || '').toUpperCase()}</td>
      <td>${p.model || ''}</td>
      <td>${p.quality ? `<span class="tag ${/orig/i.test(p.quality)?'purple':''}">${p.quality}</span>` : ''}</td>
      <td>${(p.price ?? 0)} ${(p.currency || '')}</td>
      <td>
        <div class="qty" data-id="${p.id}">
          <button aria-label="–ú–∏–Ω—É—Å">‚àí</button>
          <strong>${p.stock ?? 0}</strong>
          <button aria-label="–ü–ª—é—Å">Ôºã</button>
        </div>
      </td>
      <td class="actions">
        <button class="iconbtn" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å" data-edit="${p.id}">‚úé</button>
        <button class="iconbtn" title="–£–¥–∞–ª–∏—Ç—å" data-del="${p.id}">üóëÔ∏è</button>
      </td>
    `;
    tb.appendChild(tr);
  });
}

// ===== –ó–∞–≥—Ä—É–∑–∫–∞/—Ñ–∏–ª—å—Ç—Ä =====
async function loadProducts() {
  const r = await fetch('/api/products');
  const js = await r.json();
  PRODUCTS = js;
  applyFilter();
}

function applyFilter() {
  const q = normalizeStr($('#q').value);
  if (!q) return renderRows(PRODUCTS);
  const list = PRODUCTS.filter(p => {
    const hay = [
      p.brand, p.model, p.quality, p.type,
      (p.tags||[]).join(' ')
    ].map(normalizeStr).join(' ');
    return hay.includes(q);
  });
  renderRows(list);
}

$('#q').addEventListener('input', () => applyFilter());

// ===== –ö–æ–ª-–≤–æ: +/- —á–µ—Ä–µ–∑ PUT =====
document.addEventListener('click', async (e) => {
  const btn = e.target.closest('.qty button');
  if (!btn) return;
  const box = btn.closest('.qty');
  const id = box.dataset.id;
  const strong = box.querySelector('strong');
  let val = parseInt(strong.textContent || '0', 10);
  if (btn.textContent.includes('Ôºã')) val += 1;
  if (btn.textContent.includes('‚àí')) val = Math.max(0, val - 1);
  strong.textContent = val;

  // –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
  await fetch('/api/products/' + id, {
    method: 'PUT',
    headers: {'Content-Type':'application/json; charset=utf-8'},
    body: JSON.stringify({ stock: val })
  });
});

// ===== –£–¥–∞–ª–µ–Ω–∏–µ =====
document.addEventListener('click', async (e) => {
  const delBtn = e.target.closest('[data-del]');
  if (!delBtn) return;
  const id = delBtn.getAttribute('data-del');
  if (!confirm('–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä?')) return;
  const r = await fetch('/api/products/' + id, { method: 'DELETE' });
  if (r.ok) loadProducts();
});

// ===== –§–æ—Ä–º–∞: –æ—Ç–∫—Ä—ã—Ç—å/–∑–∞–∫—Ä—ã—Ç—å =====
const drawer = $('#drawer');
$('#btnAdd').addEventListener('click', () => drawer.classList.add('open'));
$('#btnCancel').addEventListener('click', () => drawer.classList.remove('open'));

// ===== –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ (POST) =====
$('#addForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const f = e.target;
  const payload = {
    active: true,
    brand: normalizeStr(f.brand.value),
    model: f.model.value.trim(),
    quality: f.quality.value.trim(),
    price: Number(f.price.value || 0),
    currency: (f.currency.value || 'TJS').trim(),
    vendor: (f.vendor?.value || '').trim(),
    photo: (f.photo?.value || '').trim(),
    stock: Number(f.stock.value || 0),
    type: (f.type?.value || '').trim(),
    tags: (f.tags?.value || '').split(',').map(s => s.trim()).filter(Boolean),
    specs: specsText(f.specs.value),
  };
  const r = await fetch('/api/products', {
    method:'POST',
    headers:{'Content-Type':'application/json; charset=utf-8'},
    body: JSON.stringify(payload)
  });
  if (r.ok) {
    f.reset();
    drawer.classList.remove('open');
    loadProducts();
    alert('‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ');
  } else {
    let js={}; try{js=await r.json()}catch(_){}
    alert('‚ùå –û—à–∏–±–∫–∞: ' + (js.error || r.status));
  }
});

// ===== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è =====
loadProducts();
</script>
{% endblock %}
