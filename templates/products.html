<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Админ-панель — Дашборд</title>
  <style>
    :root{
      --bg1:#0b0b2b;
      --bg2:#1a0f3d;
      --glass:rgba(255,255,255,0.06);
      --stroke:rgba(255,255,255,0.08);
      --txt:#e9e7ff;
      --muted:#b9b4e6;
      --accent1:#ff6a00;
      --accent2:#ff00a8;
      --accent3:#6a5cff;
      --ok:#21d19f;
      --warn:#ffb020;
      --danger:#ff4d4d;
      --card-grad: linear-gradient(135deg, #ff7a00 0%, #ff2ea6 48%, #6a5cff 100%);
      --btn-grad: linear-gradient(135deg, #ff7a00 0%, #ff2ea6 100%);
      --btn-grad-purple: linear-gradient(135deg, #6a5cff 0%, #9a49ff 100%);
      --ring: 0 0 0 8px rgba(255,255,255,0.06) inset;
      --shadow-3d: 0 10px 30px rgba(0,0,0,0.55), 0 1px 0 rgba(255,255,255,0.03) inset;
      --radius-xl: 20px;
      --radius-lg: 16px;
      --radius-sm: 12px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
      color:var(--txt);
      background:
        radial-gradient(1200px 600px at -10% -10%, #43126f66, transparent 60%),
        radial-gradient(900px 600px at 110% 10%, #0aa6ff22, transparent 60%),
        linear-gradient(160deg, var(--bg1), var(--bg2));
    }

    /* Layout */
    .wrap{display:grid; grid-template-columns: 260px 1fr; min-height:100vh; gap:0}
    aside{
      position:sticky; top:0; height:100vh; padding:18px;
      background: linear-gradient(180deg, #140a33, #0e0a2a);
      border-right:1px solid var(--stroke);
      box-shadow: inset -1px 0 0 var(--stroke);
    }
    main{padding:24px 28px 32px}

    /* Sidebar */
    .brand{
      display:flex; align-items:center; gap:12px; padding:10px 12px; margin-bottom:10px;
      color:#fff; font-weight:700; letter-spacing:.3px;
      border-radius:14px;
      background:linear-gradient(135deg,#3b1c6b,#1e1749);
      box-shadow:var(--shadow-3d);
    }
    .brand .logo{
      width:34px; height:34px; display:grid; place-items:center; border-radius:12px;
      background:var(--card-grad);
      box-shadow:0 6px 18px rgba(255, 70, 160, .35);
      font-size:18px;
    }

    .nav{margin-top:14px; display:flex; flex-direction:column; gap:8px}
    .nav a{
      text-decoration:none; color:var(--muted);
      padding:12px 14px; border-radius:14px; display:flex; align-items:center; gap:12px;
      background:transparent; border:1px solid transparent;
      transition:all .25s ease; font-weight:600;
    }
    .nav a span.icon{
      width:28px; height:28px; display:grid; place-items:center; border-radius:10px;
      background:rgba(255,255,255,0.06); border:1px solid var(--stroke);
    }
    .nav a.active{
      color:#fff;
      background:linear-gradient(90deg, #ff7a00, #ff2ea6);
      box-shadow: 0 10px 22px rgba(255, 46, 166, .35), inset 0 1px 0 rgba(255,255,255,0.2);
    }
    .nav a:hover{border-color:var(--stroke); background:rgba(255,255,255,0.04); color:#fff}

    /* Header & actions */
    .topbar{display:flex; align-items:center; gap:14px; margin-bottom:18px; flex-wrap:wrap}
    h1{margin:0 12px 0 0; font-size:26px; letter-spacing:.3px; flex:0 0 auto}

    .search{
      flex:1 1 280px; display:flex; align-items:center; gap:12px; padding:12px 16px;
      border-radius:20px; border:1px solid var(--stroke);
      background:rgba(255,255,255,0.08);
      backdrop-filter: blur(10px);
      box-shadow:0 4px 10px rgba(0,0,0,.4);
      min-width:220px;
    }
    .search svg{width:20px; height:20px; fill:#cfcfea}
    .search input{
      width:100%; background:transparent; border:0; outline:none; color:var(--txt); font-size:14px;
      min-width:0;
    }

    .seg{
      display:flex; gap:10px; align-items:center;
      background:rgba(255,255,255,0.06); border:1px solid var(--stroke); border-radius:14px; padding:8px;
      flex:0 0 auto;
    }
    .seg button{
      border:0; padding:10px 14px; border-radius:12px; color:#fff; font-weight:700; cursor:pointer;
      background:var(--btn-grad); box-shadow:var(--shadow-3d);
      transition: transform .18s ease, box-shadow .18s ease, background .18s ease, color .18s ease;
      will-change: transform;
    }
    .seg button.secondary{background:var(--btn-grad-purple)}
    .seg button:hover{ transform: scale(1.06); box-shadow:0 0 12px rgba(255,255,255,.35) }
    .seg button:active{ transform: scale(0.96) }

    /* Table */
    .panel{
      background:rgba(255,255,255,0.06); border:1px solid var(--stroke);
      border-radius:20px; padding:14px; box-shadow:var(--shadow-3d);
    }
    .table-wrap{
      width:100%;
      overflow-x:auto;
      -webkit-overflow-scrolling:touch;
      scrollbar-width:thin;
    }
    .table{width:100%; border-collapse:separate; border-spacing:0 10px; margin-top:8px; min-width:720px}
    .table thead th{
      text-align:left; color:#dcd7ff; font-size:13px; font-weight:700; padding:10px 14px; white-space:nowrap;
    }
    .row{
      background:rgba(8,8,30,0.65);
      border:1px solid var(--stroke); border-radius:14px; overflow:hidden;
    }
    .row td{padding:12px 14px; font-size:14px; color:#f1eeff; white-space:nowrap}

    .tag{
      display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; font-weight:700; font-size:12px;
      background:linear-gradient(135deg,#1bd5a6,#11b37f); color:#04251d; box-shadow: inset 0 -1px 0 rgba(255,255,255,.25);
    }
    .tag.purple{background:linear-gradient(135deg,#836bff,#4c39ff); color:#0d0832}

    .qty{display:flex; align-items:center; gap:12px}
    .qty button{
      width:28px; height:28px; border-radius:10px; border:0; cursor:pointer;
      background:rgba(255,255,255,0.08); color:#fff;
      transition: transform .18s ease, box-shadow .18s ease, background .18s ease, color .18s ease;
    }
    .qty button:hover{ transform: scale(1.08); box-shadow:0 0 12px rgba(255,255,255,.35) }
    .qty button:active{ transform: scale(0.94) }

    .actions{display:flex; gap:8px}
    .iconbtn{
      width:34px; height:34px; border-radius:12px; border:1px solid var(--stroke);
      background:rgba(255,255,255,0.07); color:#fff; cursor:pointer;
      transition: transform .18s ease, box-shadow .18s ease, background .18s ease, color .18s ease;
    }
    .iconbtn:hover{ transform: scale(1.08); box-shadow:0 0 12px rgba(255,255,255,.35) }
    .iconbtn:active{ transform: scale(0.94) }

    .pager{display:flex; justify-content:space-between; align-items:center; margin-top:12px; color:var(--muted); gap:10px; flex-wrap:wrap}
    .pager .chip{
      display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border-radius:999px;
      background:rgba(255,255,255,0.06); border:1px solid var(--stroke); color:#fff; cursor:pointer;
      white-space:nowrap;
    }

    /* Grid cards */
    .grid{display:grid; grid-template-columns: repeat(12, 1fr); gap:16px; margin-top:18px}
    .col-6{grid-column: span 6}
    .col-4{grid-column: span 4}
    .col-3{grid-column: span 3}

    .card{
      border-radius:20px; padding:18px;
      background:var(--card-grad);
      box-shadow: 0 18px 45px rgba(0,0,0,.5), inset 0 1px 0 rgba(255,255,255,.25);
      color:#fff; position:relative; overflow:hidden;
    }
    .card h3{margin:0 0 12px; letter-spacing:.3px}
    .pill{
      display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px;
      background:rgba(0,0,0,.22); font-weight:700; font-size:12px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.2);
    }

    /* Responsive breakpoints (адаптация) */
    @media(max-width:1080px){
      .wrap{grid-template-columns: 84px 1fr}
      aside{padding:12px}
      .nav a span.label{display:none}
      .brand span{display:none}
    }
    @media(max-width:820px){
      main{padding:18px 16px 24px}
      .grid{grid-template-columns: repeat(6, 1fr)}
      .col-6{grid-column: span 6}
      .col-4{grid-column: span 6}
      .col-3{grid-column: span 3}
      .table{min-width:640px}
    }
    @media(max-width:560px){
      .wrap{grid-template-columns: 68px 1fr}
      .topbar{gap:10px}
      h1{font-size:22px; margin-right:8px}
      .search{flex:1 1 100%; order:3}
      .seg{order:4; width:100%; justify-content:space-between}
      .seg button{flex:1}
      .pager{justify-content:center}
      .table{min-width:580px}
    }
    @media(max-width:380px){
      .seg{gap:8px}
      .seg button{padding:9px 10px; font-size:13px}
      .pager .chip{padding:8px 12px; font-size:13px}
      .card{padding:14px}
    }

    /* Модалки/тост/формы */
    .hidden{display:none}
    .modal{position:fixed;inset:0;z-index:1000}
    .modal__backdrop{position:absolute;inset:0;background:rgba(0,0,0,.55)}
    .modal__card{position:relative;max-width:880px;margin:5vh auto;background:rgba(255,255,255,.06);
      border:1px solid var(--stroke); border-radius:20px; box-shadow:var(--shadow-3d); color:var(--txt)}
    .modal__header{display:flex;justify-content:space-between;align-items:center;padding:16px 20px;border-bottom:1px solid var(--stroke)}
    .modal__body{padding:16px 20px}
    .modal__footer{display:flex;justify-content:flex-end;gap:10px;margin:12px 0 4px}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
    .col-6{grid-column:span 6} .col-4{grid-column:span 4} .col-3{grid-column:span 3} .col-12{grid-column:span 12}
    label{display:flex;flex-direction:column;gap:6px;font-size:13px}
    input,select,textarea{background:#0b1220;color:#e5e7eb;border:1px solid var(--stroke);border-radius:10px;padding:10px}
    textarea{min-height:70px;resize:vertical}
    .btn{padding:10px 14px;border-radius:12px;border:1px solid transparent;cursor:pointer}
    .btn.primary{background:var(--btn-grad);color:#fff}
    .btn.ghost{background:transparent;border-color:var(--stroke);color:#fff}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:24px;background:rgba(0,0,0,.8);
      border:1px solid var(--stroke);padding:10px 14px;border-radius:12px;z-index:1100}
    .badge{display:inline-block;padding:4px 8px;border-radius:999px;background:rgba(255,255,255,.08);border:1px solid var(--stroke);margin:2px 6px 2px 0}
    .preview{display:flex;align-items:center;gap:10px}
    .preview img{width:64px;height:64px;object-fit:cover;border-radius:12px;border:1px solid var(--stroke)}

    /* High contrast tweaks */
    body{ font-size:15px; }
    .panel{ background:#121236; }
    .row{ background:#171748; }
    .row td{ font-size:15px; }
    .search{ background:#1a1f48; border-color:#2a2d58; }
    .iconbtn,.qty button{ background:#23265e; border-color:#2a2d58; }
    .iconbtn:hover,.qty button:hover{ background:#2c3175; }
    input,select,textarea{ background:#101633; border-color:#3c3f72; }
    input:focus,select:focus,textarea:focus{
      outline:none; border-color:#8a88ff; box-shadow:0 0 0 3px rgba(106,92,255,.25);
    }
    .modal__card{ background:#141842; }
    .modal__backdrop{ background:rgba(0,0,0,.7); }

    /* МАКСИ-АДАПТАЦИЯ для мобильных */
    @media (max-width: 480px){
      .wrap{ grid-template-columns: 58px 1fr; }
      aside{ padding:10px }
      .brand{ padding:8px 10px }
      .brand span{ display:none }
      .nav a{ padding:10px; justify-content:center }
      .nav a .label{ display:none }
      .nav a span.icon{ width:26px; height:26px }

      .topbar{ gap:8px }
      h1{ font-size:20px; margin-right:6px }
      .search{ padding:10px 12px }
      .seg{ padding:6px; gap:6px; flex-wrap:wrap }
      .seg button{ padding:10px 10px; font-size:13px; flex:1 1 calc(50% - 8px) }
      main{ padding:16px 12px 20px }
      .panel{ padding:10px; border-radius:16px }
      .card{ border-radius:16px }
      input,select,textarea{ font-size:16px } /* без зума iOS */
    }
    @media (max-width: 360px){
      .seg button{ flex:1 1 100%; }
    }

    @media (max-width: 480px){
      .table{ min-width:0; width:100%; border-spacing:0 }
      .table thead{ display:none }
      .table tbody{ display:block }
      .table tbody .row{
        display:block;
        padding:10px;
        margin:10px 0;
        border-radius:14px;
      }
      .table tbody .row td{
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap:10px;
        padding:8px 6px;
        white-space:normal;
        border-bottom:1px dashed rgba(255,255,255,0.06);
      }
      .table tbody .row td:last-child{ border-bottom:0; }
      .table tbody .row td:nth-child(1)::before{ content:"ID"; color:#b9b4e6; font-weight:600 }
      .table tbody .row td:nth-child(2)::before{ content:"Бренд"; color:#b9b4e6; font-weight:600 }
      .table tbody .row td:nth-child(3)::before{ content:"Модель"; color:#b9b4e6; font-weight:600 }
      .table tbody .row td:nth-child(4)::before{ content:"Качество"; color:#b9b4e6; font-weight:600 }
      .table tbody .row td:nth-child(5)::before{ content:"Цена"; color:#b9b4e6; font-weight:600 }
      .table tbody .row td:nth-child(6)::before{ content:"Ост."; color:#b9b4e6; font-weight:600 }
      .table tbody .row td:nth-child(7)::before{ content:"Действия"; color:#b9b4e6; font-weight:600 }

      .qty{ gap:8px }
      .qty button{ width:28px; height:28px }
      .actions{ gap:6px; justify-content:flex-end }
      .iconbtn{ width:32px; height:32px }
      .pager{ flex-direction:column; gap:8px; text-align:center }
    }

    :root{ --sab: env(safe-area-inset-bottom, 0px); }
    .modal__card{ display:flex; flex-direction:column; max-height:92vh; }
    .modal__body{ flex:1; overflow:auto; padding-bottom:calc(84px + var(--sab)); }
    .modal__footer{
      position:sticky; bottom:0; left:0; right:0;
      margin:0; padding:12px 16px;
      background:linear-gradient(180deg, rgba(20,24,66,.98), rgba(20,24,66,.92));
      border-top:1px solid var(--stroke);
      backdrop-filter: blur(6px);
      z-index:2;
    }
    @media (max-width:560px){
      .modal__card{ height:calc(100vh - 12px); max-height:none; width:calc(100vw - 16px); border-radius:14px; }
      .modal__footer{ padding-bottom:calc(12px + var(--sab)); display:grid; grid-template-columns:1fr 1fr; gap:10px; }
      .modal__footer .btn{ width:100%; min-height:44px; }
      #form-edit .col-3, #form-edit .col-4, #form-edit .col-6{ grid-column:span 12; }
      .preview img{ width:56px; height:56px }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Sidebar -->
    <aside>
      <div class="brand">
        <div class="logo">🟣</div>
        <span>Админ-панель</span>
      </div>
      <nav class="nav">
        <a class="active" href="#"><span class="icon">📊</span><span class="label">Дашборд</span></a>
        <a href="#"><span class="icon">📦</span><span class="label">Товары</span></a>
        <a href="#"><span class="icon">🧾</span><span class="label">Заказы</span></a>
        <a href="#"><span class="icon">🏬</span><span class="label">Склад</span></a>
        <a href="#"><span class="icon">📈</span><span class="label">Статистика</span></a>
        <a href="#"><span class="icon">👥</span><span class="label">Клиенты</span></a>
        <a href="/admin/china-orders"><span class="icon">🇨🇳</span><span class="label">Заказы из Китая</span></a>
        <a href="#"><span class="icon">⚙️</span><span class="label">Настройки</span></a>
      </nav>
    </aside>

    <!-- Main -->
    <main>
      <div class="topbar">
        <h1>Товары</h1>

        <div class="search" role="search" aria-label="Поиск товаров">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path d="M9.5 3a6.5 6.5 0 0 1 5.19 10.45l5.43 5.43-1.42 1.42-5.43-5.43A6.5 6.5 0 1 1 9.5 3m0 2a4.5 4.5 0 1 0 0 9 4.5 4.5 0 0 0 0-9z"/>
          </svg>
          <input id="q" placeholder="Поиск. Бренд / модель / качество / теги" />
        </div>

        <div class="seg" role="group" aria-label="Действия">
          <button type="button" id="btn-import">⇪ Импорт</button>
          <button type="button" class="secondary" id="btn-export">⤓ Экспорт</button>
          <button type="button" id="btn-add">＋ Добавить</button>
          <input type="file" id="file-import" accept="application/json" class="hidden" />
        </div>
      </div>

      <section class="panel">
        <div class="table-wrap">
          <table class="table" aria-label="Товары">
            <thead>
              <tr>
                <th>ID</th>
                <th>Бренд</th>
                <th>Модель</th>
                <th>Качество</th>
                <th>Цена</th>
                <th>Ост.</th>
                <th>Действия</th>
              </tr>
            </thead>
            <tbody id="products-body">
              <!-- ПУСТО: стартовые демо-строки удалены, список рендерится из API -->
            </tbody>
          </table>
        </div>

        <div class="pager">
          <div>
            <span class="chip">◀ Пред.</span>
            <span class="chip">След ▶</span>
          </div>
          <div>
            На странице:
            <span class="chip">10</span>
          </div>
        </div>
      </section>

      <div class="grid">
        <div class="card col-6">
          <h3>Заказы</h3>
          <div class="pill">New</div>
          <div class="pill">Confirmed</div>
          <div class="pill">Paid</div>
          <div class="pill">Shipped</div>
          <p style="opacity:.95;margin-top:10px">3 карточки. Lyyo</p>
        </div>

        <div class="card col-6" style="--card-grad: linear-gradient(135deg, #ff6b6b, #ff2ea6, #6a5cff)">
          <h3>Склад</h3>
          <div class="pill" style="background:rgba(0,0,0,.28)">⚠ Alert critical stock</div>
          <p style="opacity:.95;margin-top:10px">Example 7 · A10…</p>
        </div>

        <div class="card col-4" style="--card-grad: linear-gradient(135deg, #3bd3a8, #00b3ff)">
          <h3>Клиенты</h3>
          <div class="pill">Настройте параметры</div>
          <p style="opacity:.95;margin-top:10px">Малакмийте клиёнт на соединение</p>
        </div>

        <div class="card col-4" style="--card-grad: linear-gradient(135deg, #ff7a00, #ff2ea6)">
          <h3>Статистика</h3>
          <p class="pill">Проведите свод по складе</p>
          <p style="opacity:.95;margin-top:10px">Добавить закупку</p>
        </div>

        <div class="card col-4" style="--card-grad: linear-gradient(135deg, #8f7dff, #5fd1ff)">
          <h3>Настройки</h3>
          <p class="pill">Параметры для коллег</p>
          <p style="opacity:.95;margin-top:10px">Конфигурируйте систему</p>
        </div>
      </div>
    </main>
  </div>

  <!-- Модалка добавления/редактирования -->
  <div id="modal-edit" class="modal hidden" aria-hidden="true">
    <div class="modal__backdrop" data-close></div>
    <div class="modal__card" role="dialog" aria-modal="true" aria-labelledby="editTitle">
      <div class="modal__header">
        <h3 id="editTitle">Товар</h3>
        <button class="modal__close btn ghost" data-close title="Закрыть">✕</button>
      </div>
      <form id="form-edit" class="modal__body">
        <div class="grid" id="form-grid">
          <label class="col-3">SKU
            <input name="sku" placeholder="Напр.: IP11-KBS-BLK" />
          </label>
          <label class="col-3">Бренд*
            <input name="brand" required placeholder="Samsung / iPhone / Redmi…" />
          </label>
          <label class="col-3">Модель*
            <input name="model" required placeholder="A10 / 11 / Note 11…" />
          </label>
          <label class="col-3">Качество*
            <select name="quality" required>
              <option value="">— выберите —</option>
              <option>Original</option>
              <option>KBS</option>
              <option>Incell</option>
              <option>OLED</option>
            </select>
          </label>

          <!-- Тип экрана -->
          <label class="col-3">Тип экрана
            <select name="type">
              <option value="">— выберите —</option>
              <option>IPS</option>
              <option>OLED</option>
              <option>Incell</option>
              <option>AMOLED</option>
              <option>TFT</option>
            </select>
          </label>

          <label class="col-3">Цена (TJS)*
            <input type="number" name="price" min="0" step="0.01" required />
          </label>
          <label class="col-3">Остаток*
            <input type="number" name="stock" min="0" step="1" required />
          </label>
          <label class="col-3">Цвет
            <input name="color" placeholder="Black / White…" />
          </label>
          <label class="col-3">Гарантия (мес)
            <input type="number" name="warranty" min="0" step="1" placeholder="Напр.: 1" />
          </label>

          <label class="col-6">Совместимость
            <input name="compat" placeholder="Напр.: A10/A10s, iPhone 11…" />
          </label>
          <label class="col-6">Теги
            <input name="tags" placeholder="черный, акция, бренд KBS…" />
          </label>

          <label class="col-12">Характеристики / Примечания
            <textarea name="features" placeholder="Особенности, дефекты, комплектация…"></textarea>
          </label>

          <label class="col-8">Ссылка на изображение
            <input name="image" placeholder="https://…jpg/png" />
          </label>
          <div class="col-4 preview">
            <img id="img-preview" alt="preview" src="" onerror="this.src=''; this.style.display='none';" />
            <span id="img-note" style="opacity:.8">Превью появится после вставки URL</span>
          </div>
        </div>

        <div class="modal__footer">
          <button type="button" class="btn ghost" data-close>Отмена</button>
          <button type="submit" class="btn primary">Сохранить</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Модалка характеристик -->
  <div id="modal-details" class="modal hidden" aria-hidden="true">
    <div class="modal__backdrop" data-close></div>
    <div class="modal__card" role="dialog" aria-modal="true">
      <div class="modal__header">
        <h3>Характеристики товара</h3>
        <button class="modal__close btn ghost" data-close title="Закрыть">✕</button>
      </div>
      <div class="modal__body" id="details-body"></div>
      <div class="modal__footer">
        <button type="button" class="btn primary" data-close>Ок</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast hidden"></div>

  <script>
    /* ==== ЛОГИКА ЧЕРЕЗ СЕРВЕР API (БЕЗ localStorage и БЕЗ автозасева) ==== */

    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    function money(n){ n=Number(n||0); return n.toFixed(0)+' TJS'; }
    function toast(msg, ms=1800){ const t=$('#toast'); if(!t) return; t.textContent=msg; t.classList.remove('hidden'); setTimeout(()=>t.classList.add('hidden'), ms); }
    function oneLine(s){ return String(s||'').replace(/\s+/g,' ').trim(); }
    function parseTagsInline(v){ if(Array.isArray(v)) return v; return String(v||'').split(',').map(x=>x.trim()).filter(Boolean); }

    async function apiFetch(url, opts={}){
      const res = await fetch(url, {credentials:'same-origin', ...opts});
      if(res.status===401){ location.href='/login?next='+encodeURIComponent(location.pathname); throw new Error('Unauthorized'); }
      if(!res.ok){
        let errTxt='';
        try{ errTxt = await res.text(); }catch{}
        throw new Error(errTxt || (res.status+' '+res.statusText));
      }
      const ct = res.headers.get('content-type')||'';
      return ct.includes('application/json') ? res.json() : res.text();
    }

    const API = {
      list: () => apiFetch('/api/products'),
      create: (item) => apiFetch('/api/products', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify(item)
      }),
      update: (id, patch) => apiFetch(`/api/products/${id}`, {
        method:'PUT', headers:{'Content-Type':'application/json'},
        body: JSON.stringify(patch)
      }),
      remove: (id) => apiFetch(`/api/products/${id}`, { method:'DELETE' }),
      bulk: (items) => apiFetch('/api/products/bulk', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify(items)
      }),
    };

    let products = [];
    let editingId = null;

    function render(list = products){
      const q = ($('#q')?.value || '').trim().toLowerCase();
      const filtered = list.filter(p => {
        if(!q) return true;
        const hay = [
          p.id, p.brand, p.model, p.quality, p.vendor, p.type, (p.tags||[]).join(' '), String(p.price), String(p.stock), p.specs || ''
        ].join(' ').toLowerCase();
        return hay.includes(q);
      });
      $('#products-body').innerHTML = filtered.map(p => `
        <tr class="row" data-id="${p.id}">
          <td>${p.id}</td>
          <td>${p.brand}</td>
          <td>${p.model}</td>
          <td><span class="tag ${p.quality==='Original' ? 'purple' : ''}">${p.quality}</span></td>
          <td>${money(p.price)}</td>
          <td>
            <div class="qty">
              <button class="btn-dec" aria-label="Минус">−</button>
              <strong>${p.stock}</strong>
              <button class="btn-inc" aria-label="Плюс">＋</button>
            </div>
          </td>
          <td class="actions">
            <button class="iconbtn btn-show" title="Показать характеристики">👁️</button>
            <button class="iconbtn btn-edit" title="Редактировать">✎</button>
            <button class="iconbtn btn-del" title="Удалить">🗑️</button>
          </td>
        </tr>
      `).join('');
    }

    function fillForm(p){
      const f = $('#form-edit');
      f.sku.value = p?.sku || '';
      f.brand.value = p?.brand || '';
      f.model.value = p?.model || '';
      f.quality.value = p?.quality || '';
      f.type && (f.type.value = p?.type || '');
      f.price.value = p?.price ?? '';
      f.stock.value = p?.stock ?? '';
      f.color.value = p?.color || '';
      f.warranty.value = p?.warranty ?? '';
      f.compat.value = p?.compat || '';
      f.tags.value = (p?.tags || []).join(', ');
      f.features.value = p?.specs || p?.features || '';
      f.image.value = p?.photo || p?.image || '';
      previewImage(f.image.value);
    }

    function collectForm(){
      const f = $('#form-edit');
      return {
        brand: oneLine(f.brand.value).toLowerCase(),
        model: oneLine(f.model.value),
        quality: oneLine(f.quality.value),
        price: Number(f.price.value),
        currency: 'TJS',
        stock: parseInt(f.stock.value,10),
        photo: oneLine(f.image.value),
        vendor: '',
        type: oneLine(f.type ? f.type.value : ''),
        tags: parseTagsInline(f.tags.value),
        specs: oneLine(f.features.value),
        active: true
      };
    }

    function previewImage(url){
      const img=$('#img-preview'), note=$('#img-note');
      if(url){ img.src=url; img.style.display='block'; if(note) note.textContent='Превью'; }
      else { img.src=''; img.style.display='none'; if(note) note.textContent='Превью появится после вставки URL'; }
    }

    function showDetails(p){
      const d = $('#details-body');
      d.innerHTML = `
        <div class="grid">
          <div class="col-12 preview" style="margin-bottom:8px">
            ${p.photo ? `<img src="${p.photo}" alt="img" />` : ''}
            <div><strong>${p.brand} ${p.model}</strong> — ${p.quality} · ${money(p.price)} · Остаток: ${p.stock}</div>
          </div>
          <div class="col-3"><b>SKU:</b> ${p.sku || '—'}</div>
          <div class="col-3"><b>Цвет:</b> ${p.color || '—'}</div>
          <div class="col-3"><b>Гарантия:</b> ${p.warranty ?? '—'}</div>
          <div class="col-3"><b>Совместимость:</b> ${p.compat || '—'}</div>
          <div class="col-12"><b>Тип:</b> ${p.type || '—'}</div>
          <div class="col-12"><b>Теги:</b> ${(p.tags||[]).map(t=>`<span class="badge">${t}</span>`).join('') || '—'}</div>
          <div class="col-12"><b>Примечания:</b><br>${p.specs ? p.specs.replace(/\n/g,'<br>') : '—'}</div>
        </div>
      `;
      openModal('#modal-details');
    }

    function openModal(id='#modal-edit'){ $(id).classList.remove('hidden'); $(id).setAttribute('aria-hidden','false'); }
    function closeModal(id){ $(id).classList.add('hidden'); $(id).setAttribute('aria-hidden','true'); }
    function closeAll(){ ['#modal-edit','#modal-details'].forEach(id=>closeModal(id)); }

    async function onAdd(){
      editingId = null;
      $('#editTitle').textContent = 'Добавить товар';
      $('#form-edit').reset(); previewImage('');
      openModal('#modal-edit'); $('#form-edit [name="brand"]').focus();
    }
    function onEdit(id){
      const p = products.find(x=>x.id===id); if(!p) return;
      editingId = id;
      $('#editTitle').textContent = 'Изменить товар';
      fillForm(p); openModal('#modal-edit');
    }
    async function onDelete(id){
      if(!confirm('Удалить товар?')) return;
      await API.remove(id);
      products = products.filter(x=>x.id!==id);
      render(); toast('Товар удалён');
    }
    async function onSave(e){
      e.preventDefault();
      const payload = collectForm();
      if(!payload.brand || !payload.model || !payload.quality || isNaN(payload.price) || isNaN(payload.stock)){
        toast('Заполните обязательные поля корректно'); return;
      }
      if(!editingId){
        const saved = await API.create(payload);
        products.unshift(saved);
      } else {
        const saved = await API.update(editingId, payload);
        const i = products.findIndex(x=>x.id===editingId);
        if(i>=0) products[i] = saved;
      }
      render(); closeAll(); toast('Сохранено');
    }

    async function onTableClick(e){
      const btn = e.target.closest('button'); if(!btn) return;
      const tr = e.target.closest('tr.row'); if(!tr) return;
      const id = tr.dataset.id;
      const i = products.findIndex(x=>x.id===id); if(i<0) return;

      if(btn.classList.contains('btn-inc') || btn.textContent==='＋'){
        const patch = {...products[i], stock: (products[i].stock||0)+1};
        const saved = await API.update(id, patch);
        products[i] = saved; render();
      }
      if(btn.classList.contains('btn-dec') || btn.textContent==='−'){
        const patch = {...products[i], stock: Math.max(0, (products[i].stock||0)-1)};
        const saved = await API.update(id, patch);
        products[i] = saved; render();
      }

      if(btn.classList.contains('btn-edit') || btn.title==='Редактировать'){ onEdit(id); }
      if(btn.classList.contains('btn-del')  || btn.title==='Удалить'){ onDelete(id); }
      if(btn.classList.contains('btn-show') || btn.title==='Показать характеристики'){ showDetails(products[i]); }
    }

    /* === Импорт/Экспорт (устойчивый к форматам) === */

    function normalizeRow(x){
      return {
        brand: (x.brand || '').toString().trim().toLowerCase(),
        model: (x.model || '').toString().trim(),
        quality: (x.quality || '').toString().trim(),
        price: Number(x.price || 0),
        currency: (x.currency || 'TJS').toString().trim(),
        vendor: (x.vendor || '').toString().trim(),
        photo: (x.photo || x.image || '').toString().trim(),
        stock: Number(x.stock || 0),
        type: (x.type || '').toString().trim(),
        tags: Array.isArray(x.tags) ? x.tags : String(x.tags||'').split(',').map(s=>s.trim()).filter(Boolean),
        specs: (x.specs || x.features || '').toString(),
        active: (typeof x.active === 'boolean') ? x.active : true
      };
    }

    async function bulkFallback(items){
      // если нет /bulk — отправляем по одному
      const created = [];
      for(const it of items){
        try{ created.push(await API.create(it)); }
        catch(e){ console.warn('bulkFallback item error', e); }
      }
      return { added: created.length, merged: 0 };
    }

    async function importJSONToServer(file){
      try{
        const text = await file.text();
        let data = JSON.parse(text);

        // поддержка форматов:
        // 1) [ {...}, {...} ]
        // 2) { "items":[...]} / { "products":[...] }
        // 3) { "data":[...]} / { "rows":[...]}
        const arrayCandidates = Array.isArray(data) ? data
          : Array.isArray(data.items) ? data.items
          : Array.isArray(data.products) ? data.products
          : Array.isArray(data.data) ? data.data
          : Array.isArray(data.rows) ? data.rows
          : null;

        if(!arrayCandidates){ toast('Неверный формат: нужен массив объектов'); return; }
        if(arrayCandidates.length===0){ toast('Файл пуст'); return; }

        const payload = arrayCandidates.map(normalizeRow);

        let res;
        try{
          res = await API.bulk(payload);
        }catch(err){
          // если сервер не поддерживает /bulk — fallback
          console.warn('bulk API failed, fallback to one-by-one', err);
          res = await bulkFallback(payload);
        }

        toast(`Импорт: добавлено ${res.added||0}${typeof res.merged==='number' ? ', объединено '+res.merged : ''}`);
        products = await API.list();
        render();
      }catch(err){
        console.error(err);
        toast('Ошибка импорта: ' + (err.message || 'неизвестно'));
      }
    }

    function exportJSONFromClient(){
      try{
        const data = JSON.stringify(products, null, 2);
        const blob = new Blob([data], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'products_export.json';
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
        toast('Экспортирован JSON');
      }catch(e){
        console.error(e);
        toast('Ошибка экспорта');
      }
    }

    // Доп. улучшение: автопревью по вводу URL
    (function(){
      const imgInput = document.querySelector('#form-edit input[name="image"]');
      if(imgInput){
        imgInput.addEventListener('input', ()=> previewImage(imgInput.value.trim()));
      }
    })();

    // Закрытие модалок
    (function(){
      $$('#modal-edit [data-close], #modal-details [data-close]').forEach(el=> el.addEventListener('click', closeAll));
      document.addEventListener('keydown', e=>{ if(e.key==='Escape') closeAll(); });
      $$('#modal-edit .modal__backdrop, #modal-details .modal__backdrop').forEach(b => b.addEventListener('click', closeAll));
    })();

    async function init(){
      $('#btn-add')?.addEventListener('click', onAdd);
      $('#form-edit')?.addEventListener('submit', onSave);
      $('#products-body')?.addEventListener('click', onTableClick);
      $('#q')?.addEventListener('input', ()=>render());

      // Импорт/Экспорт
      $('#btn-import')?.addEventListener('click', ()=> $('#file-import')?.click());
      $('#file-import')?.addEventListener('change', async (e)=>{
        const f = e.target.files?.[0];
        if(f) await importJSONToServer(f);
        e.target.value='';
      });
      $('#btn-export')?.addEventListener('click', exportJSONFromClient);

      // Загрузка с сервера (без автодемо-строк)
      products = await API.list();
      render();
    }
    init();
  </script>
</body>
</html>
