<!-- templates/products.html -->
{% extends "base.html" %}
{% block content %}
<h2>üì¶ –¢–æ–≤–∞—Ä—ã</h2>

<form id="addForm">
  <label>–ë—Ä–µ–Ω–¥: <input name="brand" required></label><br>
  <label>–ú–æ–¥–µ–ª—å: <input name="model" required></label><br>
  <label>–ö–∞—á–µ—Å—Ç–≤–æ: <input name="quality"></label><br>
  <label>–¶–µ–Ω–∞: <input name="price" type="number"></label><br>
  <label>–í–∞–ª—é—Ç–∞: <input name="currency" value="TJS"></label><br>
  <label>Vendor: <input name="vendor"></label><br>
  <label>–§–æ—Ç–æ (URL): <input name="photo"></label><br>
  <label>–û—Å—Ç–∞—Ç–æ–∫: <input name="stock" type="number" value="0"></label><br>
  <label>–¢–∏–ø: <input name="type"></label><br>
  <label>–¢—ç–≥–∏ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é): <input name="tags"></label><br>
  <label>–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ (specs):<br>
    <textarea name="specs" rows="4" cols="50" placeholder='–î–∏–∞–≥–æ–Ω–∞–ª—å: 6.1"\n–ú–∞—Ç—Ä–∏—Ü–∞: OLED\n–ì–∞—Ä–∞–Ω—Ç–∏—è: 15 –¥–Ω–µ–π'></textarea>
  </label><br>
  <button type="submit">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
</form>

<hr>
<h3>–°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤</h3>
<table border="1" id="tbl">
  <thead>
    <tr>
      <th>–ú–æ–¥–µ–ª—å</th>
      <th>–ö–∞—á–µ—Å—Ç–≤–æ</th>
      <th>–¶–µ–Ω–∞</th>
      <th>–í–∞–ª—é—Ç–∞</th>
      <th>Vendor</th>
      <th>–§–æ—Ç–æ</th>
      <th>–û—Å—Ç–∞—Ç–æ–∫</th>
      <th>–ê–∫—Ç–∏–≤–µ–Ω</th>
      <th>–î–µ–π—Å—Ç–≤–∏—è</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
async function loadProducts() {
  const r = await fetch('/api/products');
  const js = await r.json();
  const tb = document.querySelector('#tbl tbody');
  tb.innerHTML = '';
  js.forEach(p => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${p.model}</td>
      <td>${p.quality || ''}</td>
      <td>${p.price}</td>
      <td>${p.currency}</td>
      <td>${p.vendor || ''}</td>
      <td>${p.photo ? `<img src="${p.photo}" width="40">` : ''}</td>
      <td>${p.stock || 0}</td>
      <td>${p.active ? '‚úÖ' : '‚ùå'}</td>
      <td>
        <button onclick="delProduct('${p.id}')">–£–¥–∞–ª–∏—Ç—å</button>
      </td>
    `;
    tb.appendChild(tr);
  });
}

async function delProduct(id) {
  if (!confirm('–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä?')) return;
  const r = await fetch('/api/products/' + id, { method: 'DELETE' });
  if (r.ok) loadProducts();
}

function parseSpecs(text) {
  const s = (text || '').trim();
  if (!s) return {};
  try {
    return JSON.parse(s); // –µ—Å–ª–∏ –≤–≤–µ–ª–∏ JSON
  } catch (_) {
    const out = {};
    s.split('\n').forEach(line => {
      const i = line.indexOf(':');
      if (i > 0) {
        const k = line.slice(0, i).trim();
        const v = line.slice(i + 1).trim();
        if (k) out[k] = v;
      }
    });
    return out;
  }
}

document.getElementById('addForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const f = e.target;

  const payload = {
    brand: (f.brand.value || '').trim().toLowerCase(),
    model: (f.model.value || '').trim(),
    quality: (f.quality.value || '').trim(),
    price: Number(f.price.value || 0),
    currency: (f.currency.value || 'TJS').trim(),
    vendor: (f.vendor.value || '').trim(),
    photo: (f.photo.value || '').trim(),
    stock: Number(f.stock.value || 0),
    type: (f.type.value || '').trim(),
    tags: (f.tags.value || '').split(',').map(s => s.trim()).filter(Boolean),
    specs: parseSpecs(f.specs.value),
    active: true,
  };

  const r = await fetch('/api/products', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });
  const js = await r.json();
  if (r.ok) {
    alert('‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ');
    f.reset();
    loadProducts();
  } else {
    alert('‚ùå –û—à–∏–±–∫–∞: ' + (js.error || r.status));
  }
});

loadProducts();
</script>
{% endblock %}
